

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=dark>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/bg/%E5%A4%B4%E5%83%8F.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Wei Shao">
  <meta name="keywords" content="">
  
    <meta name="description" content="Redis 入门问题的抛出出现的问题：  海量用户 高并发  罪魁祸首——关系型数据库：  性能瓶颈：磁盘IO性能低下 扩展瓶颈：数据关系复杂，扩展性差，不便于大规模集群  解决思路 降低磁盘IO次数，越低越好 —— 内存存储 去除数据间的关系，越简单越好 —— 不存储关系，仅存储数据  Nosql简介NoSQL：即Not-OnlySQL（泛指非关系型的数据库），作为关系型数据库的补充。 作用：应">
<meta property="og:type" content="article">
<meta property="og:title" content="黑马程序员-Redis">
<meta property="og:url" content="https://weishao-996.github.io/2022/10/08/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/index.html">
<meta property="og:site_name" content="WeiBlog">
<meta property="og:description" content="Redis 入门问题的抛出出现的问题：  海量用户 高并发  罪魁祸首——关系型数据库：  性能瓶颈：磁盘IO性能低下 扩展瓶颈：数据关系复杂，扩展性差，不便于大规模集群  解决思路 降低磁盘IO次数，越低越好 —— 内存存储 去除数据间的关系，越简单越好 —— 不存储关系，仅存储数据  Nosql简介NoSQL：即Not-OnlySQL（泛指非关系型的数据库），作为关系型数据库的补充。 作用：应">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221008185402254.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221008185941452.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221008190042511.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221008190110484.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FtcW0zMw==,size_16,color_FFFFFF,t_70.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/20200409191821527.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221008193222956.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221008193637593.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221008193707121.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221008194430071.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221008195132656.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221008195627422.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/20200413220259916.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FtcW0zMw==,size_16,color_FFFFFF,t_70-16652303781884.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FtcW0zMw==,size_16,color_FFFFFF,t_70-16652314848056.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FtcW0zMw==,size_16,color_FFFFFF,t_70-16652318807278.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FtcW0zMw==,size_16,color_FFFFFF,t_70-166523190155910.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FtcW0zMw==,size_16,color_FFFFFF,t_70-166523194297412.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FtcW0zMw==,size_16,color_FFFFFF,t_70-166523626646014.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221008215815344.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FtcW0zMw==,size_16,color_FFFFFF,t_70-166523647532016.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221008220123068.png">
<meta property="og:image" content="https://./img-blog.csdnimg.cn/20200419195350115.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FtcW0zMw==,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FtcW0zMw==,size_16,color_FFFFFF,t_70-16652943755982.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/20200420110014423.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FtcW0zMw==,size_16,color_FFFFFF,t_70-16652944831775.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FtcW0zMw==,size_16,color_FFFFFF,t_70-16652961455767.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FtcW0zMw==,size_16,color_FFFFFF,t_70-16652965719209.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FtcW0zMw==,size_16,color_FFFFFF,t_70-166529658190511.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FtcW0zMw==,size_16,color_FFFFFF,t_70-166529756430013.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/20200420131157293.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/20200420132321704.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FtcW0zMw==,size_16,color_FFFFFF,t_70-166529806574817.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FtcW0zMw==,size_16,color_FFFFFF,t_70-166529807350419.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221009174400409.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221009174553101.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221009174829031.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221009175046572.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221009204434585.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221009210540279.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010115536757.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010120957375.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010121604452.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010122116412.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010122310424.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010123927631.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010124244936.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010125149349.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010130449881.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010130013766.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010130712193.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010130827016.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010164820275.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010165103534.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010170628637.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010170643138.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010170926880.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010171723018.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010172032344.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010211312492.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010211455930.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010211925344.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010212001633.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010212159279.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010212520404.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010215027206.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010215129772.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221011141609019.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221011142127323.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221011142306626.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221011142546510.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221011142827574.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221011152156869.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221011164116974.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221012100201807.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221011165301074.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221012100448914.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221012100544751.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221012102219574.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221012102721225.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221012155613605.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221012155656032.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221012155840377.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221012160408015.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221012161432189.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221012161628529.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221012161728903.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221012165810588.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221012181836503.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221013125505629.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221013131128283.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221013144136576.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221013144200317.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221013144754957.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221013145837784.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221013150235170.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221013151212923.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221013151238928.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221013151547838.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221014131638733.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221014132248229.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221014133100016.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221014134814217.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221014134931474.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221014135302634.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221014140142843.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221014142336498.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221014162507268.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221014162532151.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221017163836418.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221017163847015.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221017164832371.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221017165447946.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221017200718612.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221017201122179.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221017202520833.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221017202628618.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221017203447084.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221017203710563.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221017203741205.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221017204007153.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221017204029344.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221017204901267.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221017204924813.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221017212932073.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221017213705310.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221017214240292.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221017214743888.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221017214956086.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221018164806918.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221018165949891.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221018171711366.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221018182810865.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221018182922458.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221018211141094.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221018211919137.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221018212228270.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221018213515776.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221018213813008.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221018213903729.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221018214102909.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221018214557474.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221018214924564.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221018215154820.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221018215320585.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221018215520080.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221018215630899.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221018215802938.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221019151305171.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221019151729961.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221019151925079.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221019155153179.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221019202524994.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221019202725003.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221019203036948.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221019203813171.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221019204608998.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221019210603285.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221019210730122.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221019211136036.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221019211257396.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221019211557357.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221019212827549.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221019213943319.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221019214204996.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221019215041069.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221019221124005.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221019221255502.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020103923017.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020104041099.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020104442095.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020104543307.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020104914459.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020105340354.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020105938279.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020110725445.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020110909594.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020111001703.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020111147479.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020111637321.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020112004426.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020113758577.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020162205314.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020164447238.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020165330711.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020165344324.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020165518327.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020165557352.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020165707597.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020165743895.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020165841955.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020170658042.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020170824761.png">
<meta property="og:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020171634657.png">
<meta property="article:published_time" content="2022-10-08T10:48:31.000Z">
<meta property="article:modified_time" content="2022-10-20T09:18:18.000Z">
<meta property="article:author" content="Wei Shao">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://weishao-996.github.io/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221008185402254.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>黑马程序员-Redis - WeiBlog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/prism/1.27.0/plugins/line-numbers/prism-line-numbers.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"weishao-996.github.io","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"Java"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"left","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>威少のBlog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/bg/iTab-6ozkzl.jfif') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="黑马程序员-Redis"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-10-08 18:48" pubdate>
          2022年10月8日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    

    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="padding-left: 2rem; margin-right: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">黑马程序员-Redis</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="Redis-入门"><a href="#Redis-入门" class="headerlink" title="Redis 入门"></a>Redis 入门</h1><h2 id="问题的抛出"><a href="#问题的抛出" class="headerlink" title="问题的抛出"></a>问题的抛出</h2><p><strong>出现的问题：</strong></p>
<ul>
<li>海量用户</li>
<li>高并发</li>
</ul>
<p><strong>罪魁祸首——关系型数据库：</strong></p>
<ul>
<li>性能瓶颈：磁盘IO性能低下</li>
<li>扩展瓶颈：数据关系复杂，扩展性差，不便于大规模集群</li>
</ul>
<h2 id="解决思路"><a href="#解决思路" class="headerlink" title="解决思路"></a><strong>解决思路</strong></h2><ul>
<li>降低磁盘IO次数，越低越好 —— 内存存储</li>
<li>去除数据间的关系，越简单越好 —— 不存储关系，仅存储数据</li>
</ul>
<h2 id="Nosql简介"><a href="#Nosql简介" class="headerlink" title="Nosql简介"></a>Nosql简介</h2><p>NoSQL：<br>即<code>Not-OnlySQL</code>（泛指非关系型的数据库），作为关系型数据库的补充。</p>
<p>作用：<br>应用对于海量用户和海量数据前提吓得数据处理问题。</p>
<p>特征：</p>
<ul>
<li>可扩容，可伸缩</li>
<li>大数据量下得高性能</li>
<li>灵活得数据模型</li>
<li>高可用</li>
</ul>
<p>常见<code>Nosql</code>数据库：</p>
<ul>
<li>Redis</li>
<li>memcache</li>
<li>HBase</li>
<li>MongoDB</li>
</ul>
<h2 id="解决方案（电商场景）"><a href="#解决方案（电商场景）" class="headerlink" title="解决方案（电商场景）"></a>解决方案（电商场景）</h2><p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221008185402254.png" srcset="/img/loading.gif" lazyload alt="image-20221008185402254"></p>
<h2 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h2><p>概念：<br><code>Redis(REmote DIctinary Server)</code>是用C语言开发的一个开源的高性能键值对<code>(key-value)</code>数据库<br>特征：</p>
<ul>
<li><p>数据间没有必然的关联关系</p>
</li>
<li><p>内部采用单线程机制进行工作</p>
</li>
<li><p>高性能。官方提供测试数据，50个并发执行100000个请求，读的速度是110000次/s，写的速度是81000次/s。</p>
</li>
<li><p>多数据类型支持：<code>string（字符串类型）</code>、<code>list（列表类型）</code>、<code>hash（散列类型）</code>、<code>set（集合类型）</code>、<code>sorted_set（有序集合类型）</code></p>
</li>
<li><p>持久化支持。可以进行数据灾难恢复</p>
</li>
</ul>
<h2 id="Redis的应用"><a href="#Redis的应用" class="headerlink" title="Redis的应用"></a>Redis的应用</h2><ul>
<li>为热点数据加速查询（主要场景）、如热点商品、热点新闻、热点资讯、推广类等提高访问量信息等。</li>
<li>任务队列、如秒杀、抢购、购票等</li>
<li>即时信息查询，如各位排行榜、各类网站访问统计、公交到站信息、在线人数信息（聊天室、网站）、设备信号等</li>
<li>时效性信息控制，如验证码控制，投票控制等</li>
<li>分布式数据共享，如分布式集群构架中的<code>session</code>分离</li>
<li>消息队列</li>
<li>分布式锁</li>
</ul>
<h2 id="Redis的基本操作"><a href="#Redis的基本操作" class="headerlink" title="Redis的基本操作"></a>Redis的基本操作</h2><p>命令行模式工具使用思考</p>
<ul>
<li>功能性命令</li>
<li>清除屏幕信息</li>
<li>帮助信息查阅</li>
<li>退出指令</li>
</ul>
<h3 id="信息添加"><a href="#信息添加" class="headerlink" title="信息添加"></a>信息添加</h3><ul>
<li>功能：设置key,value数据</li>
<li>命令</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">set</span> key value<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li>范例</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">set</span> name itheima<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<h3 id="信息查询"><a href="#信息查询" class="headerlink" title="信息查询"></a>信息查询</h3><ul>
<li>功能：根据key查询对应的value,如果不存在，返回空（null)</li>
<li>命令</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">get key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li>范例</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">get name<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221008185941452.png" srcset="/img/loading.gif" lazyload alt="image-20221008185941452"></p>
<h3 id="清除屏幕信息"><a href="#清除屏幕信息" class="headerlink" title="清除屏幕信息"></a>清除屏幕信息</h3><ul>
<li>功能：清除屏幕中的信息</li>
<li>命令</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">clear</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<h3 id="帮助命令"><a href="#帮助命令" class="headerlink" title="帮助命令"></a>帮助命令</h3><ul>
<li>功能：获取命令帮助文档，获取组中所有命令信息名称</li>
<li>命令</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">help</span> 命令名称
<span class="token builtin class-name">help</span> @组名<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221008190042511.png" srcset="/img/loading.gif" lazyload alt="image-20221008190042511"></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221008190110484.png" srcset="/img/loading.gif" lazyload alt="image-20221008190110484"></p>
<p>推出客户端命令行模式</p>
<ul>
<li>功能：推出客户端</li>
<li>命令</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">quit
<span class="token builtin class-name">exit</span>
<span class="token operator">&lt;</span> ESC<span class="token operator">></span><span class="token punctuation">(</span>慎用<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure>

<h1 id="Redis-数据类型"><a href="#Redis-数据类型" class="headerlink" title="Redis 数据类型"></a>Redis 数据类型</h1><h2 id="Redis数据类型-String"><a href="#Redis数据类型-String" class="headerlink" title="Redis数据类型 String"></a>Redis数据类型 String</h2><h3 id="学习资料"><a href="#学习资料" class="headerlink" title="学习资料"></a>学习资料</h3><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1CJ411m7Gc?p=6">https://www.bilibili.com/video/BV1CJ411m7Gc?p=6</a></p>
<h3 id="数据存储类型介绍"><a href="#数据存储类型介绍" class="headerlink" title="数据存储类型介绍"></a>数据存储类型介绍</h3><p>业务数据的特殊性</p>
<p><strong>作为缓存使用</strong></p>
<ol>
<li>原始业务功能设计<br>秒杀<br>618活动<br>双十一活动<br>排队购票</li>
<li>运营平台监控到的突发高频访问数据<br>突发市政要闻，被强势关注围观</li>
<li>高频、复杂的统计数据<br>在线人数<br>投票排行榜</li>
</ol>
<p><strong>附加功能</strong><br>系统功能优化或升级</p>
<ul>
<li>单服务器升级集群</li>
<li><code>Session</code>管理</li>
<li><code>Token</code>管理</li>
</ul>
<h3 id="Redis-数据类型（5种常用）"><a href="#Redis-数据类型（5种常用）" class="headerlink" title="Redis 数据类型（5种常用）"></a>Redis 数据类型（5种常用）</h3><ul>
<li>string –&gt; String</li>
<li>hash –&gt; Hashmap</li>
<li>list –&gt; LinkList</li>
<li>set –&gt; HashSet</li>
<li>sorted_set –&gt; TreeSet</li>
</ul>
<h3 id="String"><a href="#String" class="headerlink" title="String"></a>String</h3><p><strong>redis 数据存储格式</strong></p>
<ul>
<li>redis自身是一个<code>Map</code>,其中所有的数据都是采用<code>key:value</code>的形式存储</li>
<li>数据类型指的是存储的数据的类型，也就是<code>value</code>部分的类型，<code>key</code>部分永远都是字符串</li>
</ul>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FtcW0zMw==,size_16,color_FFFFFF,t_70.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<ul>
<li><strong>String 类型</strong></li>
<li>存储的数据：单个数据，最贱的数据存储类型，也是最常用的数据存储类型</li>
<li>存储数据的格式：一个存储空间保存一个数据</li>
<li>存储内容：通常使用字符串，如果字符串以整数的形式展示，可以作为数字操作使用</li>
</ul>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/20200409191821527.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h3 id="String-类型数据的基本操作"><a href="#String-类型数据的基本操作" class="headerlink" title="String 类型数据的基本操作"></a><strong>String 类型数据的基本操作</strong></h3><ul>
<li>添加/修改数据</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">set</span> key value<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li>获取数据</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">get key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li>删除数据</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">del key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li>添加/修改多个数据</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mset key1 valueq key2 value2 …<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li>获取多个数据</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mget key1 key2 …<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li>获取数据字符个数（字符串长度）</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">strlen key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li>追加信息到原始信息后部（如果原始信息存在就追加，否则新建）</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">append key value<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221008193222956.png" srcset="/img/loading.gif" lazyload alt="image-20221008193222956"></p>
<h3 id="String类型数据的扩展操作"><a href="#String类型数据的扩展操作" class="headerlink" title="String类型数据的扩展操作"></a>String类型数据的扩展操作</h3><p><strong>业务场景</strong><br>大型企业级应用中，分表操作是基本操作，使用多张表存储同类型数据，但是对应的主键id必须保证统一性，不能重复。Oracle数据库具有sequence设定，可以解决该问题，但是MySQL数据库并不具有类似的机制，那么如何解决？</p>
<p><strong>解决方案</strong></p>
<ul>
<li>设置数值数据增加指定范围的值</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">incr key
incrby key increment
incrbyfloat key increment<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure>

<ul>
<li>设置数值数据减少指定范围的值</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">decr key
decrby key increment<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221008193637593.png" srcset="/img/loading.gif" lazyload alt="image-20221008193637593"></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221008193707121.png" srcset="/img/loading.gif" lazyload alt="image-20221008193707121"></p>
<p><strong>String作为数值操作</strong></p>
<p><code>String</code>在<code>redis</code>内部存储默认就是一个字符串，当遇到增减类操作<code>incr</code>,<code>decr</code>时会转成数值型进行计算<br><code>redis</code>所有的操作都是原子性的，采用单线程处理所有业务，命令是一个一个执行的，因此无需考虑并发带来的数据影响。<br>注意：按数值进行操作的数据，如果原始数据不能转成数值，或超过了<code>redis</code>数值上线范围，将会报错。<code>9223372036854775807</code> (java中long型数据最大值，<code>Long.MAX_VALUE</code>)</p>
<h3 id="String-数据时效性设置"><a href="#String-数据时效性设置" class="headerlink" title="String 数据时效性设置"></a>String 数据时效性设置</h3><p><strong>业务场景</strong></p>
<ul>
<li><p>场景一：“最强女生”，启动海选投票，只能通过微信投票，每个微信号每4个小时只能投1票。</p>
</li>
<li><p>场景二：电商商家开启热门商品推荐，热门商品不能一直处于热门期，每种商品热门期维持3天，3天后自动取消热门</p>
</li>
<li><p>场景三：新闻网站会出现热点新闻，热点新闻最大的特征是对时效性，如何自动控制热点新闻的时效性</p>
</li>
</ul>
<p><strong>解决方案</strong></p>
<ul>
<li>设置数据具有指定的声明周期</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">setex key seconds value
psetex key milliseconds value<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221008194430071.png" srcset="/img/loading.gif" lazyload alt="image-20221008194430071"></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221008195132656.png" srcset="/img/loading.gif" lazyload alt="image-20221008195132656"></p>
<p><code>psetex</code> 和 <code>setex</code> 作用一样，都是设置过期时间，区别是：<code>psetex</code> 时间单位是毫秒，<code>setex</code> 是秒。</p>
<p>Tips 2:</p>
<ul>
<li><code>redis</code> 控制数据的生命周期，通过数据是否失效控制业务行为，适用于所有具有时效性限定控制的操作</li>
</ul>
<h3 id="String-类型的注意事项"><a href="#String-类型的注意事项" class="headerlink" title="String 类型的注意事项"></a>String 类型的注意事项</h3><ul>
<li><p>数据操作不成功的反馈与数据正常操作之间的差异</p>
<ul>
<li><p>1、表示运行结果是否成功<br> <code>（integer)0–&gt;false </code>失败<br>   <code>（integer)1–&gt;true </code>成功</p>
</li>
<li><p>2、表示运行结果值<br> <code>（integer)3–&gt;3 </code>3个<br>   <code>（integer)1–&gt;1 </code>1个</p>
</li>
</ul>
</li>
<li><p>数据未获取到<code>(nil）</code>等同于<code>null</code></p>
</li>
<li><p>数据最大存储量<code>512MB</code></p>
</li>
<li><p>数值计算最大范围（java中的long的最大值）</p>
</li>
</ul>
<h3 id="String类型应用场景"><a href="#String类型应用场景" class="headerlink" title="String类型应用场景"></a>String类型应用场景</h3><p><strong>业务场景</strong><br>主页高频访问信息显示控制，例如新浪微博大V主页显示粉丝数与微博数量</p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221008195627422.png" srcset="/img/loading.gif" lazyload alt="image-20221008195627422"></p>
<h3 id="key的设置约定"><a href="#key的设置约定" class="headerlink" title="key的设置约定"></a>key的设置约定</h3><p>数据库中的热点数据<code>key</code>命名惯例</p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/20200413220259916.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h2 id="Redis数据类型-Hash"><a href="#Redis数据类型-Hash" class="headerlink" title="Redis数据类型 Hash"></a>Redis数据类型 Hash</h2><h3 id="学习教程"><a href="#学习教程" class="headerlink" title="学习教程"></a>学习教程</h3><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1CJ411m7Gc?p=12">https://www.bilibili.com/video/BV1CJ411m7Gc?p=12</a></p>
<h3 id="Hash类型"><a href="#Hash类型" class="headerlink" title="Hash类型"></a>Hash类型</h3><p><strong>存储的困惑</strong><br>对象类数据的存储如果具有较为频繁的更新需求操作会显得笨重</p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FtcW0zMw==,size_16,color_FFFFFF,t_70-16652303781884.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h3 id="hash类型"><a href="#hash类型" class="headerlink" title="hash类型"></a><strong>hash类型</strong></h3><ul>
<li>新的存储需求：对一系列存储的数据进行编组，方便管理，典型应用存储对象信息</li>
<li>需要的内存结构：一个存储空间保存多少个键值对数据</li>
<li><code>hash</code>类型：底层使用哈希表结构实现数据存储</li>
</ul>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FtcW0zMw==,size_16,color_FFFFFF,t_70-16652314848056.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h3 id="hash类型数据的基本操作"><a href="#hash类型数据的基本操作" class="headerlink" title="hash类型数据的基本操作"></a>hash类型数据的基本操作</h3><ul>
<li>添加/修改数据</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">hset key field value<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li>获取数据</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hget key field
hgetall key<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<ul>
<li>删除数据</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hdel key field1 <span class="token punctuation">[</span>field2<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li>添加/修改多个数据</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hmset key field1 value1 field2 calue2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li>获取多个数据</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hmget key field1 field2 …<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li>获取哈希表中字段的数量</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hlen key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li>获取哈希表中是否存在指定的字段</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hexists key field<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<h3 id="hash类型数据扩展操作"><a href="#hash类型数据扩展操作" class="headerlink" title="hash类型数据扩展操作"></a>hash类型数据扩展操作</h3><ul>
<li>获取哈希表中所有的字段名和字段值</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hkeys key
hvals key<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<ul>
<li>设置指定字段的数值数据增加指定范围的值</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hincrby key field increment
hincrbyfloat key field increment<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<h3 id="hash类型数据操作的注意事项"><a href="#hash类型数据操作的注意事项" class="headerlink" title="hash类型数据操作的注意事项"></a>hash类型数据操作的注意事项</h3><ul>
<li>hash类型下的<code>value</code>只能存储字符串，不允许存储其他类型数据，不存在嵌套现象。如果数据未获取到，对应的值为<code>(nil)</code></li>
<li>每个<code>hash</code>可以存储<code>232-1</code>个键值对</li>
<li><code>hash</code>类型十分贴近对象的数据存储形式，并且可以灵活添加删除对象属性。但<code>hash</code>设计初中不是为了存储大量对象而设计的，切记不可滥用，更不可以将<code>hash</code>作为对象列表使用</li>
<li><code>hgetall</code>操作可以获取全部属性，如果内部<code>field</code>过多，遍历整体数据效率就会很低，有可能成为数据访问瓶颈</li>
</ul>
<h3 id="hash类型应用场景购物车"><a href="#hash类型应用场景购物车" class="headerlink" title="hash类型应用场景购物车"></a>hash类型应用场景购物车</h3><p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FtcW0zMw==,size_16,color_FFFFFF,t_70-16652318807278.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FtcW0zMw==,size_16,color_FFFFFF,t_70-166523190155910.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h3 id="Hash实现抢购"><a href="#Hash实现抢购" class="headerlink" title="Hash实现抢购"></a>Hash实现抢购</h3><p>Hash应用场景</p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FtcW0zMw==,size_16,color_FFFFFF,t_70-166523194297412.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><strong>解决方案</strong></p>
<ul>
<li>以商家<code>id</code>作为<code>key</code></li>
<li>将参与抢购的商品<code>id</code>作为<code>field</code></li>
<li>将参与抢购的商品数量作为对应的<code>value</code></li>
<li>抢购时使用降至的方式控制产品数量</li>
</ul>
<h2 id="Redis数据存储-List"><a href="#Redis数据存储-List" class="headerlink" title="Redis数据存储 List"></a>Redis数据存储 List</h2><h3 id="list类型"><a href="#list类型" class="headerlink" title="list类型"></a>list类型</h3><ul>
<li>数据存储需求：存储多个数据，并对数据进入存储空间的顺序进行区分</li>
<li>需要的存储数据：一个存储空间保存多个数据，且通过数据可以体现进入顺序</li>
<li>list类型：保存多个数据，底层使用双向链表存储结构实现</li>
</ul>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FtcW0zMw==,size_16,color_FFFFFF,t_70-166523626646014.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h3 id="list类型数据基本操作"><a href="#list类型数据基本操作" class="headerlink" title="list类型数据基本操作"></a>list类型数据基本操作</h3><ul>
<li><strong>添加/修改数据</strong></li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">lpush key value1 <span class="token namespace">[value2]</span> …
rpush key value1 <span class="token namespace">[value2]</span> …<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<ul>
<li><strong>获取数据</strong></li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">lrange key start stop
lindex key index
llen key<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure>

<ul>
<li><strong>删除并移除数据</strong></li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">lpop key
rpop key<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<h3 id="list-类型数组扩展操作"><a href="#list-类型数组扩展操作" class="headerlink" title="list 类型数组扩展操作"></a><strong>list 类型数组扩展操作</strong></h3><ul>
<li><strong>规定时间内获取并移除数据</strong></li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">blpop key1 [key2] timeout
brpop key1 [key2] timeout<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221008215815344.png" srcset="/img/loading.gif" lazyload alt="image-20221008215815344"><br>阻塞式获取，获取值如果还没有的时候可以等，如果有值就可以获取到。</p>
<h3 id="业务场景"><a href="#业务场景" class="headerlink" title="业务场景"></a>业务场景</h3><p>微信朋友圈点赞，要求按照点赞顺序显示点赞好友信息，如果取消点赞，移除对应好友信息</p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FtcW0zMw==,size_16,color_FFFFFF,t_70-166523647532016.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<ul>
<li><strong>移除指定数据</strong></li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">lrem key count value<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221008220123068.png" srcset="/img/loading.gif" lazyload alt="image-20221008220123068"></p>
<ul>
<li><code>redis</code>应用于具有操作线后顺序的数据控制</li>
</ul>
<h3 id="list类型数据操作注意事项"><a href="#list类型数据操作注意事项" class="headerlink" title="list类型数据操作注意事项"></a>list类型数据操作注意事项</h3><ul>
<li><code>list </code>中保存的数据都是<code>string</code>类型的，数据总容量式由西安的，最多<code>232-1</code>个元素<code>（4294967295）</code></li>
<li>list具有索引的概念，但是操作数据时候通常以队列的形式进行入队出队操作，或以栈的形式进入栈出栈的操作</li>
<li>获取全部数据操作结束索引设置为<code>-1</code></li>
<li><code>list</code> 可以对数据进行分页操作，通过第一页的信息来自<code>list</code>，第2页及更多的信息通过数据库的形式加载</li>
</ul>
<h3 id="list类型应用场景"><a href="#list类型应用场景" class="headerlink" title="list类型应用场景"></a>list类型应用场景</h3><p><strong>业务场景</strong></p>
<ul>
<li><p>twitter、新浪微博、腾讯微博中个人用于的关注列表需要按照用户的关注顺序进行展示，粉丝列表需要将最近关注的粉丝列在前面</p>
</li>
<li><p>新闻、资讯类网站如何将最新的新闻或资讯按照发生的事件顺序展示</p>
</li>
<li><p>企业运营过程中，系统将产生出大量的运营数据，如何保障堕胎服务器操作日志的统一顺序输出？</p>
<p>解决方案</p>
</li>
<li><p>依赖list的数据具有顺序的特征对信息进行管理</p>
</li>
<li><p>使用队列模型解决多路信息汇总合并的问题</p>
</li>
<li><p>使用栈模型解决最新消息的问题</p>
</li>
</ul>
<h2 id="Redis数据类型-Set"><a href="#Redis数据类型-Set" class="headerlink" title="Redis数据类型 Set"></a>Redis数据类型 Set</h2><ul>
<li>新的存储需求：存储大量的数据，在查询方面提供更高的效率</li>
<li>休要的存储结构：能够保存大量的数据，搞笑的内部存储机制，便于查询</li>
<li>set类型：与hash存储结构完全相同，仅存储键，不存储值（nil),并且值式不允许重复的</li>
</ul>
<h3 id="set类型数据的基本操作"><a href="#set类型数据的基本操作" class="headerlink" title="set类型数据的基本操作"></a>set类型数据的基本操作</h3><ul>
<li>添加数据</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sadd key menber1 <span class="token punctuation">[</span>member2<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li>获取全部数据</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">smembers key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li>删除数据</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">srem key member1 <span class="token punctuation">[</span>member2<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li>获取集合数据总量</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">scard key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li>判断集合中是否包含指定数据</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sismember key member<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<h3 id="set类型数据的扩展操作"><a href="#set类型数据的扩展操作" class="headerlink" title="set类型数据的扩展操作"></a>set类型数据的扩展操作</h3><p><strong>业务场景</strong><br>每位用户首次使用进入头条时候会设置3项爱好的内容，但是后期为了增加用户的活跃度，兴趣点，必须让用户对其他信息类别逐渐产生兴趣，增加客户留存度，如何实现？</p>
<p><strong>业务分析</strong></p>
<ul>
<li><p>系统分析出各个分类的最新或最热点信息条目并组织成set集合</p>
</li>
<li><p>随机挑选其中部分信息</p>
</li>
<li><p>配合用户关注信息分类中的热点信息组织展示的全信息集合</p>
</li>
</ul>
<p><strong>解决方案</strong></p>
<ul>
<li>随机获取集合中指定数量的数据</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">srandmember key <span class="token punctuation">[</span>count<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li>随机获取集合中的某个数据并将该数据移出集合</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">spop key <span class="token punctuation">[</span>count<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li>redis应用于随机推荐类信息检索，例如热点歌单推荐，热点新闻推荐，热点旅游线路，应用APP推荐，大V推荐等</li>
</ul>
<h3 id="set类型数据的扩展操作-1"><a href="#set类型数据的扩展操作-1" class="headerlink" title="set类型数据的扩展操作"></a>set类型数据的扩展操作</h3><p><strong>业务场景</strong></p>
<p><img src="https://./img-blog.csdnimg.cn/20200419195350115.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FtcW0zMw==,size_16,color_FFFFFF,t_70" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><strong>解决方案</strong></p>
<ul>
<li>求两个集合的交、并、差集</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sinter key1 <span class="token punctuation">[</span>key2<span class="token punctuation">]</span>
sunion key1 <span class="token punctuation">[</span>key2<span class="token punctuation">]</span>
<span class="token function">sdiff</span> key1 <span class="token punctuation">[</span>key2<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure>

<ul>
<li>求两个集合的交、并、差集并存储到指定集合中</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sinterstore destination key1 <span class="token punctuation">[</span>key2<span class="token punctuation">]</span>
sunionstore destination key1 <span class="token punctuation">[</span>key2<span class="token punctuation">]</span>
sdiffstore destination key1 <span class="token punctuation">[</span>key2<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure>

<ul>
<li>将指定数据从原始集合移动到目标集合中</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">smove <span class="token builtin class-name">source</span> destination member<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li><code>redis</code>应用于同类信息的关联搜索，二度关联搜索，深度关联搜索</li>
<li>显示共同关注（一度）</li>
<li>显示共同好友（一度）</li>
<li>由用户A出发，获取到好友用户B的好友信息列表（一度）</li>
<li>由用户A出发，获取到好友用户B的购物清单列表（二度）</li>
<li>由用户A出发，获取到好友用户B的游戏充值列表（二度）</li>
</ul>
<h3 id="Set类型数据操作的注意事项"><a href="#Set类型数据操作的注意事项" class="headerlink" title="Set类型数据操作的注意事项"></a>Set类型数据操作的注意事项</h3><ul>
<li><code>set</code>类型不允许数据重复，如果添加的数据在<code>set</code>中已经存在，将只保留一份</li>
<li><code>set</code>虽然与<code>hash</code>的存储结构相同，但是无法启用<code>hash</code>中存储值的空间</li>
</ul>
<p><strong>业务场景</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FtcW0zMw==,size_16,color_FFFFFF,t_70-16652943755982.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><strong>解决方案</strong></p>
<ul>
<li>依赖set集合数据不重复的特征，依赖set集合hash存储结构特征完成数据过滤与快速查询</li>
<li>根据用户id获取用户所有角色</li>
<li>根据用户所有角色获取用户所有操作权限放入set集合</li>
<li>根据用户所有觉得获取用户所有数据全选放入set集合</li>
</ul>
<p><strong>校验工作</strong>：redis提供基础数据还是提供校验结果<br>Tips 10:</p>
<ul>
<li>redis应用于同类型不重复数据的合并操作</li>
</ul>
<h3 id="set类型应用场景"><a href="#set类型应用场景" class="headerlink" title="set类型应用场景"></a>set类型应用场景</h3><p><strong>业务场景</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/20200420110014423.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><strong>解决方案</strong></p>
<ul>
<li>利用set集合的数据去重特征，记录各种访问数据</li>
<li>建立string类型数据，利用incr统计日访问量（PV)</li>
<li>建立set模型，记录不同cookie数量（UV)</li>
<li>建立set模型，记录不同IP数量（IP)</li>
</ul>
<p><strong>业务场景（黑白名单）</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FtcW0zMw==,size_16,color_FFFFFF,t_70-16652944831775.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><strong>解决方案</strong></p>
<ul>
<li><p>基于经营战略设定问题用户发现、鉴别规则</p>
</li>
<li><p>周期性更行满足规则的用户黑名单，加入set集合</p>
</li>
<li><p>用户行为信息达到后与黑名单进行比比对，确认行为去向</p>
</li>
<li><p>黑名单过滤IP地址：应用于开放游客访问权限的信息源</p>
</li>
<li><p>黑名单过滤设备信息：应用于限定访问设备的信息源</p>
</li>
<li><p>黑名单过滤用户：应用于基于访问权限的信息源</p>
</li>
</ul>
<p>Tips 12:</p>
<ul>
<li>redis应用于基于黑名单与白名单设定的服务控制</li>
</ul>
<h2 id="Redis数据类型-sorted-set"><a href="#Redis数据类型-sorted-set" class="headerlink" title="Redis数据类型 sorted_set"></a>Redis数据类型 sorted_set</h2><ul>
<li>新的存储需求：根据排序有利于数据的有效显示，需要提供一种可以根据自身特征进行排序的方式</li>
<li>需要的存储结构：新的存储模型，可以保存可排序的数据</li>
<li>sorted_set类型：在set的存储结构基础上添加可排序字段</li>
</ul>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FtcW0zMw==,size_16,color_FFFFFF,t_70-16652961455767.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h3 id="sorted-set类型数据的基本操作"><a href="#sorted-set类型数据的基本操作" class="headerlink" title="sorted_set类型数据的基本操作"></a>sorted_set类型数据的基本操作</h3><ul>
<li>添加数据</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">zadd key score1 member1 <span class="token punctuation">[</span>score2 member2<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li>获取全部数据</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">zrange key start stop <span class="token punctuation">[</span>WITHSCORES<span class="token punctuation">]</span>
zrevrange key start stop <span class="token punctuation">[</span>WITHSCORES<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<ul>
<li>删除数据</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">zrem key member <span class="token punctuation">[</span>member …<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li>按条件获取数据</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">zrangebyscore key min max <span class="token punctuation">[</span>WITHSCORES<span class="token punctuation">]</span> <span class="token punctuation">[</span>LIMIT<span class="token punctuation">]</span>
zrevrangebyscore key max min <span class="token punctuation">[</span>WITHSCORES<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<ul>
<li>条件删除</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">zremrangebyrank key start stop
zremrangebyscore key min max<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p><strong>注意</strong>：</p>
<ul>
<li><p><code>min</code>与<code>max</code>用于限定搜索查询的条件</p>
</li>
<li><p><code>start</code>与<code>stop</code>用于限定查询范围，作用于索引，表示开始和结束索引</p>
</li>
<li><p><code>offset</code>与<code>count</code>用于限定查询范围，作用于查询结果，表示<code>开始位置</code>和<code>数据总量</code></p>
</li>
<li><p>获取集合数据总量</p>
</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">zcard key
zcount key min max<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<ul>
<li>集合交、并操作</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">zinterstore destination numkeys key <span class="token punctuation">[</span>key …<span class="token punctuation">]</span>
zunionstore destination numkeys key <span class="token punctuation">[</span>key …<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p>计算给定的一个或多个有序集的交集，其中给定 <code>key</code> 的数量必须以 <code>numkeys</code> 参数指定，并将该交集(结果集)储存到 <code>destination</code> 。</p>
<h3 id="sorted-set-类型数据的扩展操作"><a href="#sorted-set-类型数据的扩展操作" class="headerlink" title="sorted_set 类型数据的扩展操作"></a>sorted_set 类型数据的扩展操作</h3><p><strong>业务场景</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FtcW0zMw==,size_16,color_FFFFFF,t_70-16652965719209.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FtcW0zMw==,size_16,color_FFFFFF,t_70-166529658190511.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><strong>解决方案</strong></p>
<ul>
<li>获取数据对应的索引（排名）</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">zrank key member
zrevrank key member<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<ul>
<li>score 值获取与修改</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">zscore key member
zincrby key increment member<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FtcW0zMw==,size_16,color_FFFFFF,t_70-166529756430013.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>Tips 13:</p>
<ul>
<li><code>redis </code>应用于计数器组合排序功能对应的排名</li>
</ul>
<h3 id="sorted-set-类型数据操作的注意事项"><a href="#sorted-set-类型数据操作的注意事项" class="headerlink" title="sorted_set 类型数据操作的注意事项"></a>sorted_set 类型数据操作的注意事项</h3><ul>
<li><p>score 保存的数据存储空间是<code>64</code>位，如果是整数范围是</p>
</li>
<li><p>score保存的数据也可以是一个双精度的<code>double</code>值，基于双精度浮点数的特征，可能会丢失精度，使用时侯要慎重</p>
</li>
<li><p>sorted_set底层存储还是基于set结构的，因此数据不能重复，如果重复添加相同的数据，<code>score</code>值将被反复覆盖，保留最后一次修改的结果</p>
</li>
</ul>
<p><strong>业务场景</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/20200420131157293.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>解决方案</p>
<ul>
<li><p>对于基于时间线限定的任务处理，将处理时间记录位<code>score</code>值，利用排序功能区分处理的先后顺序</p>
</li>
<li><p>记录下一个要处理的事件，当到期后处理对应的任务，移除<code>redis</code>中的记录，并记录下一个要处理的时间</p>
</li>
<li><p>当新任务加入时，判定并更新当前下一个要处理的任务时间</p>
</li>
<li><p>为提升<code>sorted_set</code>的性能，通常将任务根据特征存储成若干个<code>sorted_set</code>.例如1小时内，1天内，年度等，操作时逐渐提升，将即将操作的若干个任务纳入到1小时内处理队列中</p>
</li>
<li><p>获取当前系统时间</p>
</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">time</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>Tips 14</p>
<ul>
<li><code>redis</code>应用于定时任务执行顺序管理或任务过期管理</li>
</ul>
<h3 id="业务场景-1"><a href="#业务场景-1" class="headerlink" title="业务场景"></a><strong>业务场景</strong></h3><p>任务/消息权重设定应用</p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/20200420132321704.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><strong>解决方案</strong></p>
<p>对于带有权重的任务，优先处理权重高的任务，采用<code>score</code>记录权重即可</p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FtcW0zMw==,size_16,color_FFFFFF,t_70-166529806574817.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FtcW0zMw==,size_16,color_FFFFFF,t_70-166529807350419.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<ul>
<li>Tips 15:</li>
<li><code>redis</code>应用于即时任务/消息队列执行管理 </li>
</ul>
<h2 id="数据类型实践案例"><a href="#数据类型实践案例" class="headerlink" title="数据类型实践案例"></a>数据类型实践案例</h2><p><strong>业务场景</strong></p>
<p>人工智能领域的语义识别与自动对话将是未来服务业机器人应答呼叫体系中的重要技术，百度自研用户评价 语义识别服务，免费开放给企业试用，同时训练百度自己的模型。现对试用用户的使用行为进行限速，限制 每个用户每分钟最多发起10次调用</p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221009174400409.png" srcset="/img/loading.gif" lazyload alt="image-20221009174400409"></p>
<p><strong>解决方案</strong></p>
<ul>
<li>设计计数器，记录调用次数，用于控制业务执行次数。以用户<code>id</code>作为<code>key</code>，使用次数作为<code>value</code> </li>
<li> 在调用前获取次数，判断是否超过限定次数 不超过次数的情况下，每次调用<code>计数+1</code> 业务调用失败，<code>计数-1 </code></li>
<li>为计数器设置生命周期为指定周期，例如<code>1秒/分钟</code>，自动清空周期内使用次数</li>
</ul>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221009174553101.png" srcset="/img/loading.gif" lazyload alt="image-20221009174553101"></p>
<p><strong>解决方案改良</strong></p>
<ul>
<li>取消最大值的判定，利用<code>incr</code>操作超过最大值抛出异常的形式替代每次判断是否大于最大值 </li>
<li>判断是否为<code>nil</code>， 如果是，设置为Max-次数 如果不是，计数+1 业务调用失败，计数-1 </li>
<li>遇到异常即+操作超过上限，视为使用达到上限</li>
</ul>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221009174829031.png" srcset="/img/loading.gif" lazyload alt="image-20221009174829031"></p>
<p><strong>业务场景</strong></p>
<p>使用微信的过程中，当微信接收消息后，会默认将最近接收的消息置顶，当多个好友及关注的订阅号同时发 送消息时，该排序会不停的进行交替。同时还可以将重要的会话设置为置顶。一旦用户离线后，再次打开微 信时，消息该按照什么样的顺序显示？</p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221009175046572.png" srcset="/img/loading.gif" lazyload alt="image-20221009175046572"></p>
<p><strong>解决方案</strong></p>
<ul>
<li>依赖list的数据具有顺序的特征对消息进行管理，将list结构作为栈使用 </li>
<li>对置顶与普通会话分别创建独立的list分别管理 </li>
<li>当某个list中接收到用户消息后，将消息发送方的id从list的一侧加入list（此处设定左侧） </li>
<li>多个相同id发出的消息反复入栈会出现问题，在入栈之前无论是否具有当前id对应的消息，先删除对应id </li>
<li>推送消息时先推送置顶会话list，再推送普通会话list，推送完成的list清除所有数据 </li>
<li>消息的数量，也就是微信用户对话数量采用计数器的思想另行记录，伴随list操作同步更新</li>
</ul>
<p><strong>Tips 17：</strong> </p>
<ul>
<li> redis 应用于基于时间顺序的数据操作，而不关注具体时间</li>
</ul>
<h3 id="解决方案列表"><a href="#解决方案列表" class="headerlink" title="解决方案列表"></a>解决方案列表</h3><ul>
<li>Tips 1：redis用于控制数据库表主键id，为数据库表主键提供生成策略，保障数据库表的主键唯一性 </li>
<li>Tips 2：redis 控制数据的生命周期，通过数据是否失效控制业务行为，适用于所有具有时效性限定控制的操作 </li>
<li>Tips 3：redis应用于各种结构型和非结构型高热度数据访问加速 </li>
<li>Tips 4：redis 应用于购物车数据存储设计 </li>
<li>Tips 5：redis 应用于抢购，限购类、限量发放优惠卷、激活码等业务的数据存储设计 </li>
<li>Tips 6：redis 应用于具有操作先后顺序的数据控制 </li>
<li>Tips 7：redis 应用于最新消息展示 </li>
<li>Tips 8：redis 应用于随机推荐类信息检索，例如热点歌单推荐，热点新闻推荐，热卖旅游线路，应用APP推荐，大V推荐等 </li>
<li>Tips 9：redis 应用于同类信息的关联搜索，二度关联搜索，深度关联搜索 </li>
<li>Tips 10：redis 应用于同类型不重复数据的合并、取交集操作 </li>
<li>Tips 11：redis 应用于同类型数据的快速去重 </li>
<li>Tips 12：redis 应用于基于黑名单与白名单设定的服务控制 </li>
<li>Tips 13：redis 应用于计数器组合排序功能对应的排名 </li>
<li>Tips 14：redis 应用于定时任务执行顺序管理或任务过期管理 </li>
<li>Tips 15：redis 应用于及时任务/消息队列执行管理 </li>
<li>Tips 16：redis 应用于按次结算的服务控制 </li>
<li>Tips 17：redis 应用于基于时间顺序的数据操作，而不关注具体时间</li>
</ul>
<h1 id="Redis-通用指令"><a href="#Redis-通用指令" class="headerlink" title="Redis 通用指令"></a>Redis 通用指令</h1><h2 id="key通用指令"><a href="#key通用指令" class="headerlink" title="key通用指令"></a>key通用指令</h2><h3 id="key-特征"><a href="#key-特征" class="headerlink" title="key 特征"></a><strong>key 特征</strong></h3><p>key是一个字符串，通过<code>key</code>获取<code>redis</code>中保存的数据</p>
<p><strong>key应该设计哪些操作？</strong></p>
<ul>
<li>对于key自身状态的相关操作，例如：删除，判定存在，获取类型等 </li>
<li>对于key有效性控制相关操作，例如：有效期设定，判定是否有效，有效状态的切换等 </li>
<li>对于key快速查询操作，例如：按指定策略查询key </li>
<li>……</li>
</ul>
<h3 id="key-基本操作"><a href="#key-基本操作" class="headerlink" title="key 基本操作"></a>key 基本操作</h3><h4 id="删除指定key"><a href="#删除指定key" class="headerlink" title="删除指定key"></a><strong>删除指定key</strong></h4><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">del key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> <span class="token function">del</span> string
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> get string
<span class="token punctuation">(</span>nil<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h4 id="获取key是否存在"><a href="#获取key是否存在" class="headerlink" title="获取key是否存在"></a><strong>获取key是否存在</strong></h4><figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">exists key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> exists list1
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<h4 id="获取key的类型"><a href="#获取key的类型" class="headerlink" title="获取key的类型"></a><strong>获取key的类型</strong></h4><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">type</span> key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> <span class="token function">type</span> list1
list<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<h3 id="key-扩展操作（时效性控制）"><a href="#key-扩展操作（时效性控制）" class="headerlink" title="key 扩展操作（时效性控制）"></a>key 扩展操作（时效性控制）</h3><h4 id="为指定key设置有效期"><a href="#为指定key设置有效期" class="headerlink" title="为指定key设置有效期"></a><strong>为指定key设置有效期</strong></h4><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">expire key seconds
pexpire key milliseconds
expireat key timestamp
pexpireat key milliseconds-timestamp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> expire name 10
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> get name
<span class="token string">"weiwshao"</span>
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> get name
<span class="token punctuation">(</span>nil<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> expireat name 1665310700
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> get name
<span class="token string">"weishao"</span>
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> time
1<span class="token punctuation">)</span> <span class="token string">"1665310693"</span>
2<span class="token punctuation">)</span> <span class="token string">"637763"</span>
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> get name
<span class="token string">"weishao"</span>
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> get name
<span class="token punctuation">(</span>nil<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><code>EXPIREAT</code> 的作用和 <code>EXPIRE</code> 类似，都用于为 <code>key</code> 设置生存时间。不同在于 <code>EXPIREAT</code> 命令接受的时间参数是 UNIX 时间戳(unix timestamp)。</p>
<h4 id="获取key的有效时间"><a href="#获取key的有效时间" class="headerlink" title="获取key的有效时间"></a><strong>获取key的有效时间</strong></h4><figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">ttl key
pttl key<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> <span class="token function">set</span> name weishao
OK
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> ttl name
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token operator">-</span>1
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> expire name 10
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> ttl name
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 7
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> ttl name
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 3
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> pttl name
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token operator">-</span>2
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> <span class="token function">set</span> name weishao
OK
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> pttl name
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token operator">-</span>1
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> expire name 10
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> pttl name
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 7061
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> pttl name
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token operator">-</span>2
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<ul>
<li>当 <code>key</code> 不存在时，返回 <code>-2</code> 。</li>
<li>当 <code>key</code> 存在但没有设置剩余生存时间时，返回 <code>-1</code> 。</li>
<li>否则，以毫秒为单位，返回 <code>key</code> 的剩余生存时间。</li>
</ul>
<h4 id="切换key从时效性转换为永久性"><a href="#切换key从时效性转换为永久性" class="headerlink" title="切换key从时效性转换为永久性"></a><strong>切换key从时效性转换为永久性</strong></h4><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">persist key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> expire name 10
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> ttl name
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 7
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> persist name
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> ttl name
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token operator">-</span>1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="key-扩展操作（查询模式）"><a href="#key-扩展操作（查询模式）" class="headerlink" title="key 扩展操作（查询模式）"></a>key 扩展操作（查询模式）</h3><h4 id="查询key"><a href="#查询key" class="headerlink" title="查询key"></a><strong>查询key</strong></h4><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">keys pattern<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><strong>查询模式规则</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">* 匹配任意数量的任意符号 ? 配合一个任意符号 <span class="token punctuation">[</span><span class="token punctuation">]</span> 匹配一个指定符号
keys * 查询所有
keys it* 查询所有以it开头
keys *heima 查询所有以heima结尾
keys ??heima 查询所有前面两个字符任意，后面以heima结尾
keys user:? 查询所有以user:开头，最后一个字符任意
keys u<span class="token punctuation">[</span>st<span class="token punctuation">]</span>er:1 查询所有以u开头，以er:1结尾，中间包含一个字母，s或t<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h4 id="key-其他操作"><a href="#key-其他操作" class="headerlink" title="key 其他操作"></a><strong>key 其他操作</strong></h4><h5 id="为key改名"><a href="#为key改名" class="headerlink" title="为key改名"></a>为key改名</h5><figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">rename key newkey
renamenx key newkey<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> <span class="token function">set</span> name weishao
OK
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> rename name name2
OK
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379>
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> get name2
<span class="token string">"weishao"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> get name2
<span class="token string">"weishao"</span>
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> <span class="token function">set</span> name3 123
OK
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> renamenx name2 name3
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>当且仅当 <code>newkey</code> 不存在时，将 <code>key</code> 改名为 <code>newkey</code> 。</p>
<p>当 <code>key</code> 不存在时，返回一个错误。</p>
<p>修改成功时，返回 <code>1</code> ； 如果 <code>newkey</code> 已经存在，返回 <code>0</code> 。</p>
<h5 id="对所有key排序"><a href="#对所有key排序" class="headerlink" title="对所有key排序"></a>对所有key排序</h5><figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell"><span class="token function">sort</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">127.0.0.1:6379&gt; lrange list2 0 -1
1) &quot;8&quot;
2) &quot;6&quot;
3) &quot;2&quot;
4) &quot;4&quot;
5) &quot;3&quot;
6) &quot;6&quot;
127.0.0.1:6379&gt; sort list2
1) &quot;2&quot;
2) &quot;3&quot;
3) &quot;4&quot;
4) &quot;6&quot;
5) &quot;6&quot;
6) &quot;8&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h5 id="其他key通用操作"><a href="#其他key通用操作" class="headerlink" title="其他key通用操作"></a>其他key通用操作</h5><figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">help @generic<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<h2 id="数据库通用指令"><a href="#数据库通用指令" class="headerlink" title="数据库通用指令"></a>数据库通用指令</h2><h3 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a><strong>数据库</strong></h3><h4 id="key-的重复问题"><a href="#key-的重复问题" class="headerlink" title="key 的重复问题"></a><strong>key 的重复问题</strong></h4><ul>
<li><code>key</code>是由程序员定义的 </li>
<li><code>redis</code>在使用过程中，伴随着操作数据量的增加，会出现大量的数据以及对应的<code>key </code></li>
<li>数据不区分种类、类别混杂在一起，极易出现重复或冲突</li>
</ul>
<h4 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a><strong>解决方案</strong></h4><ul>
<li>redis为每个服务提供有16个数据库，编号从0到15 </li>
<li>每个数据库之间的数据相互独立</li>
</ul>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221009204434585.png" srcset="/img/loading.gif" lazyload alt="image-20221009204434585"></p>
<h3 id="db-基本操作"><a href="#db-基本操作" class="headerlink" title="db 基本操作"></a>db 基本操作</h3><h4 id="切换数据库"><a href="#切换数据库" class="headerlink" title="切换数据库"></a>切换数据库</h4><figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell"><span class="token function">select</span> index<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> <span class="token function">select</span> 1
OK
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379<span class="token punctuation">[</span>1<span class="token punctuation">]</span>><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure>

<h4 id="其他操作"><a href="#其他操作" class="headerlink" title="其他操作"></a>其他操作</h4><figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">quit
ping
<span class="token function">echo</span> message<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure>

<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> ping
PONG<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p>使用客户端向 Redis 服务器发送一个 <code>PING</code> ，如果服务器运作正常的话，会返回一个 <code>PONG</code> 。通常用于测试与服务器的连接是否仍然生效，或者用于测量延迟值。</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">127.0.0.1:6379&gt; echo 123
&quot;123&quot;
127.0.0.1:6379&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure>

<p>打印一个特定的信息 <code>message</code> ，测试时使用。</p>
<h3 id="db-相关操作"><a href="#db-相关操作" class="headerlink" title="db 相关操作"></a>db 相关操作</h3><h4 id="数据移动"><a href="#数据移动" class="headerlink" title="数据移动"></a>数据移动</h4><figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">move key db<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> <span class="token function">move</span> name2 1
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> exists name2
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> <span class="token function">select</span> 1
OK
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379<span class="token punctuation">[</span>1<span class="token punctuation">]</span>> keys <span class="token operator">*</span>
1<span class="token punctuation">)</span> <span class="token string">"name2"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h4 id="数据清除"><a href="#数据清除" class="headerlink" title="数据清除"></a>数据清除</h4><figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">dbsize
flushdb
flushall<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure>

<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379<span class="token punctuation">[</span>1<span class="token punctuation">]</span>> dbsize
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p>返回当前数据库的 key 的数量。</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> dbsize
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 16
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> flushdb
OK
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> dbsize
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>清空当前数据库中的所有 key。此命令从不失败。</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> dbsize
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> <span class="token function">select</span> 1
OK
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379<span class="token punctuation">[</span>1<span class="token punctuation">]</span>> dbsize
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379<span class="token punctuation">[</span>1<span class="token punctuation">]</span>> <span class="token function">select</span> 0
OK
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> flushall
OK
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> <span class="token function">select</span> 1
OK
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379<span class="token punctuation">[</span>1<span class="token punctuation">]</span>> dbsize
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>清空整个 <code>Redis</code> 服务器的数据(删除所有数据库的所有<code> key</code> )。此命令从不失败。</p>
<h1 id="Jedis"><a href="#Jedis" class="headerlink" title="Jedis"></a>Jedis</h1><h2 id="Jedis简介"><a href="#Jedis简介" class="headerlink" title="Jedis简介"></a>Jedis简介</h2><h3 id="编程语言与redis"><a href="#编程语言与redis" class="headerlink" title="编程语言与redis"></a>编程语言与redis</h3><p><code>Java</code>语言连接<code>redis</code>服务 <code>Jedis</code></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221009210540279.png" srcset="/img/loading.gif" lazyload alt="image-20221009210540279"></p>
<ul>
<li><p>Java语言连接redis服务 </p>
<ul>
<li><p>Jedis </p>
</li>
<li><p>SpringData Redis </p>
</li>
<li><p>Lettuce </p>
</li>
</ul>
</li>
<li><p>C 、C++ 、C# 、Erlang、Lua 、Objective-C 、Perl 、PHP 、Python 、Ruby 、Scala </p>
</li>
<li><p>可视化连接redis客户端 </p>
<ul>
<li><p>Redis Desktop Manager </p>
</li>
<li><p>Redis Client </p>
</li>
<li><p>Redis Studi</p>
</li>
</ul>
</li>
</ul>
<h2 id="HelloWorld（Jedis版）"><a href="#HelloWorld（Jedis版）" class="headerlink" title="HelloWorld（Jedis版）"></a>HelloWorld（Jedis版）</h2><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><ul>
<li><strong>jar包导入</strong> </li>
</ul>
<p>下载地址：<a target="_blank" rel="noopener" href="https://mvnrepository.com/artifact/redis.clients/jedis">https://mvnrepository.com/artifact/redis.clients/jedis</a></p>
<ul>
<li><strong>基于maven</strong></li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>junit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>junit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>4.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="客户端连接redis"><a href="#客户端连接redis" class="headerlink" title="客户端连接redis"></a>客户端连接redis</h3><h4 id="连接redis"><a href="#连接redis" class="headerlink" title="连接redis"></a><strong>连接redis</strong></h4><figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<h4 id="操作redis"><a href="#操作redis" class="headerlink" title="操作redis"></a><strong>操作redis</strong></h4><figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java">jedis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"itheima"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
jedis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<h4 id="关闭redis连接"><a href="#关闭redis连接" class="headerlink" title="关闭redis连接"></a><strong>关闭redis连接</strong></h4><figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java">jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<h4 id="API文档"><a href="#API文档" class="headerlink" title="API文档"></a>API文档</h4><p><a target="_blank" rel="noopener" href="http://xetorthio.github.io/jedis/">http://xetorthio.github.io/jedis/</a></p>
<h3 id="Jedis读写redis数据"><a href="#Jedis读写redis数据" class="headerlink" title="Jedis读写redis数据"></a>Jedis读写redis数据</h3><h4 id="案例：服务调用次数控制"><a href="#案例：服务调用次数控制" class="headerlink" title="案例：服务调用次数控制"></a><strong>案例：服务调用次数控制</strong></h4><p>人工智能领域的语义识别与自动对话将是未来服务业机器人应答呼叫体系中的重要技术，百度自研用户评 价语义识别服务，免费开放给企业试用，同时训练百度自己的模型。现对试用用户的使用行为进行限速， 限制每个用户每分钟最多发起10次调用</p>
<ul>
<li><p><strong>案例要求</strong> </p>
<ul>
<li><p>① 设定A、B、C三个用户 </p>
</li>
<li><p>② A用户限制10次/分调用，B用户限制30次/分调用，C用户不限制</p>
</li>
</ul>
</li>
</ul>
<h4 id="案例：需求分析"><a href="#案例：需求分析" class="headerlink" title="案例：需求分析"></a><strong>案例：需求分析</strong></h4><ul>
<li>① 设定一个服务方法，用于模拟实际业务调用的服务，内部采用打印模拟调用 </li>
<li>② 在业务调用前服务调用控制单元，内部使用redis进行控制，参照之前的方案 </li>
<li>③ 对调用超限使用异常进行控制，异常处理设定为打印提示信息 </li>
<li>④ 主程序启动3个线程，分别表示3种不同用户的调用</li>
</ul>
<h4 id="案例：实现步骤"><a href="#案例：实现步骤" class="headerlink" title="案例：实现步骤"></a><strong>案例：实现步骤</strong></h4><ol>
<li><strong>设定业务方法</strong></li>
</ol>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">void</span> <span class="token function">business</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">,</span><span class="token keyword">long</span> num<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
 <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"用户"</span><span class="token operator">+</span>id<span class="token operator">+</span><span class="token string">"发起业务调用，当前第"</span><span class="token operator">+</span>num<span class="token operator">+</span><span class="token string">"次"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure>

<ol start="2">
<li><strong>设定多线类，模拟用户调用</strong></li>
</ol>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
     <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
     	jd<span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
     	<span class="token comment">//模拟调用间隔，设定为1.x秒</span>
         <span class="token keyword">try</span><span class="token punctuation">&#123;</span>
             <span class="token class-name">Random</span> r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token operator">+</span> r<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
             e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
         <span class="token punctuation">&#125;</span>
     <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<ol start="3">
<li><strong>设计redis控制方案</strong></li>
</ol>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">void</span> <span class="token function">service</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
     <span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token class-name">String</span> value <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"compid:"</span> <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment">//判定是否具有调用计数控制，利用异常进行控制处理</span>
     <span class="token keyword">if</span><span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
         <span class="token comment">//没有控制，创建控制计数器</span>
         jedis<span class="token punctuation">.</span><span class="token function">setex</span><span class="token punctuation">(</span><span class="token string">"compid:"</span> <span class="token operator">+</span> id<span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
         <span class="token comment">//有控制，自增，并调用业务</span>
         <span class="token keyword">try</span><span class="token punctuation">&#123;</span>
         	<span class="token class-name">Long</span> val <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">incr</span><span class="token punctuation">(</span><span class="token string">"compid:"</span><span class="token operator">+</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
         	<span class="token function">business</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span><span class="token number">10</span><span class="token operator">+</span>val<span class="token operator">-</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JedisDataException</span> e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
         <span class="token comment">//调用次数溢出，弹出提示</span>
         <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"用户："</span><span class="token operator">+</span>id<span class="token operator">+</span><span class="token string">"使用次数已达到上限，请稍后再试，或升级VIP会员"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">&#125;</span><span class="token keyword">finally</span><span class="token punctuation">&#123;</span>
     	jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     	<span class="token punctuation">&#125;</span>
     <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<ol start="4">
<li><strong>设计启动主程序</strong></li>
</ol>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
     <span class="token class-name">MyThread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token string">"初级用户"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>后续1：对业务控制方案进行改造，设定不同用户等级的判定 </p>
<p>后续2：将不同用户等级对应的信息、限制次数等设定到redis中，使用hash保存</p>
<h2 id="基于连接池获取连接"><a href="#基于连接池获取连接" class="headerlink" title="基于连接池获取连接"></a>基于连接池获取连接</h2><p>JedisPool：Jedis提供的连接池技术 </p>
<ul>
<li><code>poolConfig</code>:连接池配置对象 </li>
<li><code>host</code>:redis服务地址 </li>
<li><code>port</code>:redis服务端口号</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">JedisPool</span><span class="token punctuation">(</span><span class="token class-name">GenericObjectPoolConfig</span> poolConfig<span class="token punctuation">,</span> <span class="token class-name">String</span> host<span class="token punctuation">,</span> <span class="token keyword">int</span> port<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
 <span class="token keyword">this</span><span class="token punctuation">(</span>poolConfig<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="封装连接参数"><a href="#封装连接参数" class="headerlink" title="封装连接参数"></a>封装连接参数</h3><ul>
<li><strong>jedis.properties</strong></li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">jedis.host</span><span class="token punctuation">=</span><span class="token value attr-value">localhost</span>
<span class="token key attr-name">jedis.port</span><span class="token punctuation">=</span><span class="token value attr-value">6379</span>
<span class="token key attr-name">jedis.maxTotal</span><span class="token punctuation">=</span><span class="token value attr-value">30</span>
<span class="token key attr-name">jedis.maxIdle</span><span class="token punctuation">=</span><span class="token value attr-value">10</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="加载配置信息"><a href="#加载配置信息" class="headerlink" title="加载配置信息"></a>加载配置信息</h3><ul>
<li>静态代码块初始化资源</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">static</span><span class="token punctuation">&#123;</span>
 <span class="token comment">//读取配置文件 获得参数值</span>
 <span class="token class-name">ResourceBundle</span> rb <span class="token operator">=</span> <span class="token class-name">ResourceBundle</span><span class="token punctuation">.</span><span class="token function">getBundle</span><span class="token punctuation">(</span><span class="token string">"jedis"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 host <span class="token operator">=</span> rb<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"jedis.host"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 port <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"jedis.port"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 maxTotal <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"jedis.maxTotal"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 maxIdle <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"jedis.maxIdle"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 poolConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JedisPoolConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 poolConfig<span class="token punctuation">.</span><span class="token function">setMaxTotal</span><span class="token punctuation">(</span>maxTotal<span class="token punctuation">)</span><span class="token punctuation">;</span>
 poolConfig<span class="token punctuation">.</span><span class="token function">setMaxIdle</span><span class="token punctuation">(</span>maxIdle<span class="token punctuation">)</span><span class="token punctuation">;</span>
 jedisPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JedisPool</span><span class="token punctuation">(</span>poolConfig<span class="token punctuation">,</span>host<span class="token punctuation">,</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="获取连接"><a href="#获取连接" class="headerlink" title="获取连接"></a>获取连接</h3><ul>
<li>对外访问接口，提供<code>jedis</code>连接对象，连接从连接池获取</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Jedis</span> <span class="token function">getJedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
     <span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> jedisPool<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span> jedis<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h2 id="可视化客户端"><a href="#可视化客户端" class="headerlink" title="可视化客户端"></a>可视化客户端</h2><p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010115536757.png" srcset="/img/loading.gif" lazyload alt="image-20221010115536757"></p>
<h1 id="Redis-安装"><a href="#Redis-安装" class="headerlink" title="Redis 安装"></a>Redis 安装</h1><h2 id="基于Linux环境安装Redis"><a href="#基于Linux环境安装Redis" class="headerlink" title="基于Linux环境安装Redis"></a>基于Linux环境安装Redis</h2><ul>
<li><h3 id="下载安装包"><a href="#下载安装包" class="headerlink" title="下载安装包"></a><strong>下载安装包</strong></h3></li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> http://download.redis.io/releases/redis-?.?.?.tar.gz<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010120957375.png" srcset="/img/loading.gif" lazyload alt="image-20221010120957375"></p>
<ul>
<li><strong>解压</strong></li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">tar</span> –xvf 文件名.tar.gz<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010121604452.png" srcset="/img/loading.gif" lazyload alt="image-20221010121604452"></p>
<ul>
<li><strong>编译</strong> </li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">make</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010122116412.png" srcset="/img/loading.gif" lazyload alt="image-20221010122116412"></p>
<ul>
<li><strong>安装</strong></li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">make</span> <span class="token function">install</span> <span class="token punctuation">[</span>destdir<span class="token operator">=</span>/目录<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010122310424.png" srcset="/img/loading.gif" lazyload alt="image-20221010122310424"></p>
<h2 id="指定端口启动服务"><a href="#指定端口启动服务" class="headerlink" title="指定端口启动服务"></a>指定端口启动服务</h2><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">redis-server –-port <span class="token number">6380</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010123927631.png" srcset="/img/loading.gif" lazyload alt="image-20221010123927631"></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010124244936.png" srcset="/img/loading.gif" lazyload alt="image-20221010124244936"></p>
<h2 id="指定配置文件启动"><a href="#指定配置文件启动" class="headerlink" title="指定配置文件启动"></a>指定配置文件启动</h2><p><strong>删除配置文件 注释信息和无用空白并保存至新的配置文件<code>redis-6379</code>文件中</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> redis.conf <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token string">"#"</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token string">"^$"</span> <span class="token operator">></span> redis-6379.conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010125149349.png" srcset="/img/loading.gif" lazyload alt="image-20221010125149349"></p>
<p><strong>新建日志保存位置，并获取路径</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010130449881.png" srcset="/img/loading.gif" lazyload alt="image-20221010130449881"></p>
<p><strong>修改配置<code>redis-6379</code>文件保存必要配置</strong></p>
<p><strong>基本配置</strong> </p>
<ul>
<li>daemonize yes <ul>
<li>以守护进程方式启动，使用本启动方式，redis将以服务的形式存在，日志将不再打印到命令窗口中 </li>
</ul>
</li>
<li>port 6<ul>
<li>设定当前服务启动端口号</li>
</ul>
</li>
<li>dir “/自定义目录/redis/data“ <ul>
<li>设定当前服务文件保存位置，包含日志文件、持久化文件（后面详细讲解）等</li>
</ul>
</li>
<li>logfile 6***.log<ul>
<li>设定日志文件名，便于查阅</li>
</ul>
</li>
</ul>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010130013766.png" srcset="/img/loading.gif" lazyload alt="image-20221010130013766"></p>
<p><strong>指定配置文件<code>redis-6379.conf</code>启动</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">redis-server redis-6379.conf <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010130712193.png" srcset="/img/loading.gif" lazyload alt="image-20221010130712193"></p>
<p><strong>查看redis是否启动完成</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ps</span> <span class="token parameter variable">-ef</span> <span class="token operator">|</span> <span class="token function">grep</span> redis-<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010130827016.png" srcset="/img/loading.gif" lazyload alt="image-20221010130827016"></p>
<h2 id="配置文件启动目录管理"><a href="#配置文件启动目录管理" class="headerlink" title="配置文件启动目录管理"></a>配置文件启动目录管理</h2><p><strong>创建配置目录，并将配置文件放入目录内</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">[root@hecs-33111 redis-7.0.5]# mkdir conf
[root@hecs-33111 redis-7.0.5]# mv redis-6379.conf conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p><strong>以指定目录下的配置及文件启动redis</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@hecs-33111 redis-7.0.5<span class="token punctuation">]</span><span class="token comment"># redis-server conf/redis-6379.conf</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><strong>同时启动两个不同端口的redis</strong></p>
<ul>
<li><strong>复制配置文件并修改</strong></li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">cp redis-6379.conf redis-6380.conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010164820275.png" srcset="/img/loading.gif" lazyload alt="image-20221010164820275"></p>
<ul>
<li><strong>同时启动两个服务</strong></li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@hecs-33111 redis-7.0.5<span class="token punctuation">]</span><span class="token comment"># redis-server conf/redis-6380.conf</span>
<span class="token punctuation">[</span>root@hecs-33111 redis-7.0.5<span class="token punctuation">]</span><span class="token comment"># redis-server conf/redis-6379.conf</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010165103534.png" srcset="/img/loading.gif" lazyload alt="image-20221010165103534"></p>
<h1 id="Redis-持久化"><a href="#Redis-持久化" class="headerlink" title="Redis 持久化"></a>Redis 持久化</h1><h2 id="持久化简介"><a href="#持久化简介" class="headerlink" title="持久化简介"></a>持久化简介</h2><p><strong>意外的断电</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010170628637.png" srcset="/img/loading.gif" lazyload alt="image-20221010170628637"></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010170643138.png" srcset="/img/loading.gif" lazyload alt="image-20221010170643138"></p>
<p><strong>什么是持久化</strong></p>
<p>利用永久性存储介质将数据进行保存，在特定的时间将保存的数据进行恢复的工作机制称为持久化。</p>
<p><strong>为什么要进行持久化</strong></p>
<p>防止数据的意外丢失，确保数据安全性</p>
<p><strong>持久化过程保存什么</strong></p>
<ul>
<li>将当前数据状态进行保存，快照形式，存储数据结果，存储格式简单，关注点在数据 </li>
<li>将数据的操作过程进行保存，日志形式，存储操作过程，存储格式复杂，关注点在数据的操作过程</li>
</ul>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010170926880.png" srcset="/img/loading.gif" lazyload alt="image-20221010170926880"></p>
<h2 id="RDB"><a href="#RDB" class="headerlink" title="RDB"></a>RDB</h2><h3 id="RDB启动方式-——-save指令"><a href="#RDB启动方式-——-save指令" class="headerlink" title="RDB启动方式 —— save指令"></a>RDB启动方式 —— save指令</h3><p><strong>命令</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">save<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>作用 手动执行一次保存操作</p>
<p><strong>演示</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell"><span class="token namespace">[root@hecs-33111 redis-7.0.5]</span><span class="token comment"># redis-cli -p 6379</span>
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> 
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> 
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> 
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> save
OK<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010171723018.png" srcset="/img/loading.gif" lazyload alt="image-20221010171723018"></p>
<ul>
<li><strong>添加数据观察rdb文件变化</strong></li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> <span class="token function">set</span> name weishao
OK
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> save
OK<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010172032344.png" srcset="/img/loading.gif" lazyload alt="image-20221010172032344"></p>
<h4 id="RDB启动方式-——-save指令相关配置"><a href="#RDB启动方式-——-save指令相关配置" class="headerlink" title="RDB启动方式 —— save指令相关配置"></a>RDB启动方式 —— save指令相关配置</h4><ul>
<li><strong>dbfilename dump.rdb</strong> <ul>
<li>说明：设置本地数据库文件名，默认值为 dump.rdb </li>
<li>经验：通常设置为<code>dump-端口号.rdb </code></li>
</ul>
</li>
<li><strong>dir</strong> <ul>
<li>说明：设置存储.rdb文件的路径 </li>
<li>经验：通常设置成存储空间较大的目录中，目录名称<code>data </code></li>
</ul>
</li>
<li><strong>rdbcompression yes</strong> <ul>
<li>说明：设置存储至本地数据库时是否压缩数据，默认为<code> yes</code>，采用 <code>LZF</code> 压缩 </li>
<li>经验：通常默认为开启状态，如果设置为no，可以节省 CPU 运行时间，但会使存储的文件变大（巨大）</li>
</ul>
</li>
<li><strong>rdbchecksum yes</strong> <ul>
<li>说明：设置是否进行<code>RDB</code>文件格式校验，该校验过程在写文件和读文件过程均进行 </li>
<li>经验：通常默认为开启状态，如果设置为<code>no</code>，可以节约读写性过程约<code>10%</code>时间消耗，但是存储一定的数据损坏风险</li>
</ul>
</li>
</ul>
<p><strong>演示</strong></p>
<ul>
<li><strong>修改配置文件</strong></li>
</ul>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010211312492.png" srcset="/img/loading.gif" lazyload alt="image-20221010211312492"></p>
<ul>
<li><strong>添加数据并save,观察rdb文件是否生成</strong></li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> <span class="token builtin class-name">set</span> name weishao
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> save
OK<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010211455930.png" srcset="/img/loading.gif" lazyload alt="image-20221010211455930"></p>
<p><strong>数据恢复演示</strong></p>
<ul>
<li><strong>关闭redis进程</strong></li>
</ul>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010211925344.png" srcset="/img/loading.gif" lazyload alt="image-20221010211925344"></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010212001633.png" srcset="/img/loading.gif" lazyload alt="image-20221010212001633"></p>
<ul>
<li><strong>启动redis，观察是否有数据</strong></li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">[root@hecs-33111 redis-7.0.5]# redis-server conf&#x2F;redis-6379.conf <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010212159279.png" srcset="/img/loading.gif" lazyload alt="image-20221010212159279"></p>
<ul>
<li><strong>关闭前的数据存在，持久化生效</strong></li>
</ul>
<h4 id="RDB启动方式-——-save指令工作原理"><a href="#RDB启动方式-——-save指令工作原理" class="headerlink" title="RDB启动方式 —— save指令工作原理"></a>RDB启动方式 —— save指令工作原理</h4><p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010212520404.png" srcset="/img/loading.gif" lazyload alt="image-20221010212520404"></p>
<p><strong>RDB启动方式</strong></p>
<p><strong>数据量过大，单线程执行方式造成效率过低如何处理？</strong></p>
<p>后台执行 </p>
<ul>
<li>谁：redis操作者（用户）发起指令；redis服务器控制指令执行 </li>
<li>什么时间：即时（发起）；合理的时间（执行） </li>
<li>干什么事情：保存数据</li>
</ul>
<h3 id="RDB启动方式-——-bgsave指令"><a href="#RDB启动方式-——-bgsave指令" class="headerlink" title="RDB启动方式 —— bgsave指令"></a>RDB启动方式 —— bgsave指令</h3><ul>
<li>命令</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">bgsave<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li>作用 </li>
</ul>
<p>​    手动启动后台保存操作，但不是立即执行</p>
<p><strong>演示</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> keys *
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"name"</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> <span class="token builtin class-name">set</span> age <span class="token number">25</span>
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> get age
<span class="token string">"25"</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> bgsave
Background saving started<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010215027206.png" srcset="/img/loading.gif" lazyload alt="image-20221010215027206"></p>
<h4 id="RDB启动方式-——-bgsave指令工作原理"><a href="#RDB启动方式-——-bgsave指令工作原理" class="headerlink" title="RDB启动方式 —— bgsave指令工作原理"></a>RDB启动方式 —— bgsave指令工作原理</h4><p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221010215129772.png" srcset="/img/loading.gif" lazyload alt="image-20221010215129772"></p>
<h4 id="RDB启动方式-——-bgsave指令相关配置"><a href="#RDB启动方式-——-bgsave指令相关配置" class="headerlink" title="RDB启动方式 —— bgsave指令相关配置"></a>RDB启动方式 —— bgsave指令相关配置</h4><ul>
<li><p> dbfilename dump.rdb </p>
</li>
<li><p> dir </p>
</li>
<li><p> rdbcompression yes </p>
</li>
<li><p> rdbchecksum yes </p>
</li>
<li><p><strong>stop-writes-on-bgsave-error yes</strong> </p>
<ul>
<li><p>说明：后台存储过程中如果出现错误现象，是否停止保存操作 </p>
</li>
<li><p>经验：通常默认为开启状态</p>
</li>
</ul>
</li>
</ul>
<p><strong>RDB启动方式</strong></p>
<p>反复执行保存指令，忘记了怎么办？不知道数据产生了多少变化，何时保存？</p>
<p><strong>自动执行</strong></p>
<ul>
<li> 谁：redis服务器发起指令（基于条件） </li>
<li> 什么时间：满足条件 </li>
<li> 干什么事情：保存数据</li>
</ul>
<h3 id="RDB启动方式-——save配置"><a href="#RDB启动方式-——save配置" class="headerlink" title="RDB启动方式 ——save配置"></a>RDB启动方式 ——save配置</h3><ul>
<li><strong>配置</strong></li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">save second changes<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li><strong>作用</strong></li>
</ul>
<p>满足限定时间范围内<code>key</code>的变化数量达到指定数量即进行持久化</p>
<ul>
<li><p><strong>参数</strong></p>
<ul>
<li><p>second：监控时间范围 </p>
</li>
<li><p>changes：监控key的变化量</p>
</li>
</ul>
</li>
<li><p><strong>位置</strong></p>
<ul>
<li>在conf文件中进行配置</li>
</ul>
</li>
<li><p><strong>范例</strong></p>
</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">save <span class="token number">900</span> <span class="token number">1</span>
save <span class="token number">300</span> <span class="token number">10</span>
save <span class="token number">60</span> <span class="token number">10000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure>

<p><strong>演示</strong></p>
<p>修改配置文件，并重新以配置文件启动</p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221011141609019.png" srcset="/img/loading.gif" lazyload alt="image-20221011141609019"></p>
<p>添加数据观察<code>rdb</code>文件变化</p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221011142127323.png" srcset="/img/loading.gif" lazyload alt="image-20221011142127323"></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221011142306626.png" srcset="/img/loading.gif" lazyload alt="image-20221011142306626"></p>
<h4 id="RDB启动方式-——save配置原理"><a href="#RDB启动方式-——save配置原理" class="headerlink" title="RDB启动方式 ——save配置原理"></a>RDB启动方式 ——save配置原理</h4><p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221011142546510.png" srcset="/img/loading.gif" lazyload alt="image-20221011142546510"></p>
<h3 id="RDB三种启动方式对比"><a href="#RDB三种启动方式对比" class="headerlink" title="RDB三种启动方式对比"></a>RDB三种启动方式对比</h3><p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221011142827574.png" srcset="/img/loading.gif" lazyload alt="image-20221011142827574"></p>
<h3 id="RDB特殊启动形式"><a href="#RDB特殊启动形式" class="headerlink" title="RDB特殊启动形式"></a>RDB特殊启动形式</h3><ul>
<li><strong>全量复制</strong></li>
</ul>
<p>​        在主从复制中详细讲解</p>
<ul>
<li><strong>服务器运行过程中重启</strong></li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">debug reload<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li><strong>关闭服务器时指定保存数据</strong></li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">shutdown</span> save<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>默认情况下执行<code>shutdown</code>命令时，自动执行 <code>bgsave</code>(如果没有开启<code>AOF</code>持久化功能)</p>
<h3 id="RDB优点与缺点"><a href="#RDB优点与缺点" class="headerlink" title="RDB优点与缺点"></a>RDB优点与缺点</h3><h4 id="RDB优点"><a href="#RDB优点" class="headerlink" title="RDB优点"></a>RDB优点</h4><ul>
<li><code>RDB</code>是一个紧凑压缩的二进制文件，存储效率较高 </li>
<li> <code>RDB</code>内部存储的是<code>redis</code>在某个<code>时间点</code>的数据快照，非常适合用于数据备份，全量复制等场景 </li>
<li> <code>RDB</code>恢复数据的速度要比<code>AOF</code>快很多</li>
<li> 应用：服务器中每<code>X</code>小时执行<code>bgsave</code>备份，并将<code>RDB</code>文件拷贝到远程机器中，用于灾难恢复。</li>
</ul>
<h4 id="RDB缺点"><a href="#RDB缺点" class="headerlink" title="RDB缺点"></a>RDB缺点</h4><ul>
<li><code>RDB</code>方式无论是执行指令还是利用配置，无法做到实时持久化，具有较大的可能性丢失数据 </li>
<li><code>bgsave</code>指令每次运行要执行<code>fork</code>操作创建子进程，要牺牲掉一些性能 </li>
<li><code>Redis</code>的众多版本中未进行<code>RDB</code>文件格式的版本统一，有可能出现各版本服务之间数据格式无法兼容现象</li>
</ul>
<h2 id="AOF"><a href="#AOF" class="headerlink" title="AOF"></a>AOF</h2><h3 id="RDB存储的弊端"><a href="#RDB存储的弊端" class="headerlink" title="RDB存储的弊端"></a>RDB存储的弊端</h3><ul>
<li> 存储数据量较大，效率较低 基于快照思想，每次读写都是全部数据，当数据量巨大时，效率非常低 </li>
<li> 大数据量下的<code>IO</code>性能较低 </li>
<li> 基于<code>fork</code>创建子进程，内存产生额外消耗 </li>
<li> 宕机带来的数据丢失风险</li>
</ul>
<h4 id="解决思路-1"><a href="#解决思路-1" class="headerlink" title="解决思路"></a>解决思路</h4><ul>
<li> 不写全数据，仅记录部分数据 </li>
<li> 降低区分数据是否改变的难度，改记录数据为记录操作过程 </li>
<li> 对所有操作均进行记录，排除丢失数据的风险</li>
</ul>
<h3 id="AOF概念"><a href="#AOF概念" class="headerlink" title="AOF概念"></a>AOF概念</h3><ul>
<li> <code>AOF</code>(append only file)持久化：以独立日志的方式记录每次写命令，重启时再重新执行<code>AOF</code>文件中命令 达到恢复数据的目的。与<code>RDB</code>相比可以简单描述为改记录数据为记录数据产生的过程 </li>
<li> <code>AOF</code>的主要作用是解决了数据持久化的实时性，目前已经是<code>Redis</code>持久化的主流方式</li>
</ul>
<h3 id="AOF写数据过程"><a href="#AOF写数据过程" class="headerlink" title="AOF写数据过程"></a>AOF写数据过程</h3><p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221011152156869.png" srcset="/img/loading.gif" lazyload alt="image-20221011152156869"></p>
<h3 id="AOF写数据三种策略-appendfsync"><a href="#AOF写数据三种策略-appendfsync" class="headerlink" title="AOF写数据三种策略(appendfsync)"></a>AOF写数据三种策略(appendfsync)</h3><p> <strong>always(每次）</strong> </p>
<p>​    每次写入操作均同步到<code>AOF</code>文件中，<code>数据零误差，性能较低 </code></p>
<p> <strong>everysec（每秒）</strong> </p>
<p>​    每秒将缓冲区中的指令同步到<code>AOF</code>文件中，数据<code>准确性较高，性能较高 </code></p>
<p>​    在系统突然宕机的情况下丢失<code>1</code>秒内的数据 </p>
<p> <strong>no（系统控制）</strong> </p>
<p>​    由操作系统控制每次同步到<code>AOF</code>文件的周期，整体过程<code>不可控</code></p>
<h3 id="AOF相关配置"><a href="#AOF相关配置" class="headerlink" title="AOF相关配置"></a>AOF相关配置</h3><p><strong>配置</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">appendfilename filename<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><strong>作用</strong></p>
<p><code>AOF</code>持久化文件名，默认文件名未<code>appendonly.aof</code>，建议配置为<code>appendonly-端口号.aof</code></p>
<p><strong>配置</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">dir</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><strong>作用</strong> </p>
<p>​    <code>AOF</code>持久化文件保存路径，与<code>RDB</code>持久化文件保持一致即可</p>
<p><strong>演示</strong></p>
<p><strong>修改配置文件，并重启服务</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221011164116974.png" srcset="/img/loading.gif" lazyload alt="image-20221011164116974"></p>
<p><strong>添加数据</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> <span class="token builtin class-name">set</span> age <span class="token number">55</span>
OK<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221012100201807.png" srcset="/img/loading.gif" lazyload alt="image-20221012100201807"></p>
<h3 id="AOF写数据遇到的问题"><a href="#AOF写数据遇到的问题" class="headerlink" title="AOF写数据遇到的问题"></a>AOF写数据遇到的问题</h3><p>如果连续执行如下指令该如何处理</p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221011165301074.png" srcset="/img/loading.gif" lazyload alt="image-20221011165301074"></p>
<h3 id="AOF重写"><a href="#AOF重写" class="headerlink" title="AOF重写"></a>AOF重写</h3><p>随着命令不断写入<code>AOF</code>，文件会越来越大，为了解决这个问题，<code>Redis</code>引入了<code>AOF</code>重写机制压缩文件体积。<code>AOF</code>文件重 写是将<code>Redis</code>进程内的数据转化为写命令同步到新<code>AOF</code>文件的过程。简单说就是将对同一个数据的若干个条命令执行结 果转化成最终结果数据对应的指令进行记录。</p>
<h4 id="AOF重写作用"><a href="#AOF重写作用" class="headerlink" title="AOF重写作用"></a>AOF重写作用</h4><ul>
<li>降低磁盘占用量，提高磁盘利用率 </li>
<li>提高持久化效率，降低持久化写时间，提高IO性能 </li>
<li>降低数据恢复用时，提高数据恢复效</li>
</ul>
<h4 id="AOF重写规则"><a href="#AOF重写规则" class="headerlink" title="AOF重写规则"></a>AOF重写规则</h4><ul>
<li>进程内已超时的数据不再写入文件 </li>
<li>忽略无效指令，重写时使用进程内数据直接生成，这样新的AOF文件只保留最终数据的写入命令 如<code>del key1、 hdel key2、srem key3、set key4 111、set key4 222</code>等 </li>
<li>对同一数据的多条写命令合并为一条命令 如<code>lpush list1 a、lpush list1 b、 lpush list1 c</code> 可以转化为：<code>lpush list1 a b c</code>。 为防止数据量过大造成客户端缓冲区溢出，对<code>list、set、hash、zset</code>等类型，每条指令最多写入<code>64</code>个元素</li>
</ul>
<h4 id="重写方式"><a href="#重写方式" class="headerlink" title="重写方式"></a>重写方式</h4><ul>
<li>手动重写</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">bgrewriteaof<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li> 自动重写</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">auto-aof-rewrite-min-size size
auto-aof-rewrite-percentage percentage<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<h4 id="演示"><a href="#演示" class="headerlink" title="演示"></a>演示</h4><ul>
<li>添加数据，观察aof文件变化</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> <span class="token builtin class-name">set</span> name <span class="token number">111</span>
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> <span class="token builtin class-name">set</span> name <span class="token number">222</span>
OK<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221012100448914.png" srcset="/img/loading.gif" lazyload alt="image-20221012100448914"></p>
<ul>
<li>手动重写</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> BGREWRITEAOF
Background append only file rewriting started<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221012100544751.png" srcset="/img/loading.gif" lazyload alt="image-20221012100544751"></p>
<h4 id="AOF手动重写-——-bgrewriteaof指令工作原理"><a href="#AOF手动重写-——-bgrewriteaof指令工作原理" class="headerlink" title="AOF手动重写 —— bgrewriteaof指令工作原理"></a>AOF手动重写 —— bgrewriteaof指令工作原理</h4><p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221012102219574.png" srcset="/img/loading.gif" lazyload alt="image-20221012102219574"></p>
<h4 id="AOF自动重写方式"><a href="#AOF自动重写方式" class="headerlink" title="AOF自动重写方式"></a>AOF自动重写方式</h4><ul>
<li>自动重写触发条件设置</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">auto-aof-rewrite-min-size size
auto-aof-rewrite-percentage percent<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<ul>
<li>自动重写触发比对参数（ 运行指令info Persistence获取具体信息 ）</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">aof_current_size
aof_base_size<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<ul>
<li>自动重写触发条件</li>
</ul>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221012102721225.png" srcset="/img/loading.gif" lazyload alt="image-20221012102721225"></p>
<h3 id="AOF工作流程"><a href="#AOF工作流程" class="headerlink" title="AOF工作流程"></a>AOF工作流程</h3><p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221012155613605.png" srcset="/img/loading.gif" lazyload alt="image-20221012155613605"></p>
<h3 id="AOF重写流程"><a href="#AOF重写流程" class="headerlink" title="AOF重写流程"></a>AOF重写流程</h3><p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221012155656032.png" srcset="/img/loading.gif" lazyload alt="image-20221012155656032"></p>
<h2 id="RDB-VS-AOF"><a href="#RDB-VS-AOF" class="headerlink" title="RDB VS AOF"></a>RDB VS AOF</h2><p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221012155840377.png" srcset="/img/loading.gif" lazyload alt="image-20221012155840377"></p>
<h2 id="RDB与AOF的选择之惑"><a href="#RDB与AOF的选择之惑" class="headerlink" title="RDB与AOF的选择之惑"></a>RDB与AOF的选择之惑</h2><ul>
<li><strong>对数据非常敏感，建议使用默认的AOF持久化方案</strong> <ul>
<li>​    <code>AOF</code>持久化策略使用<code>everysecond</code>，每秒钟<code>fsync</code>一次。该策略<code>redis</code>仍可以保持很好的处理性能，当出 现问题时，最多丢失<code>0-1</code>秒内的数据。 </li>
<li>​    注意：由于<code>AOF</code>文件存储体积较大，且恢复速度较慢 </li>
</ul>
</li>
<li><strong>数据呈现阶段有效性，建议使用RDB持久化方案</strong> <ul>
<li>​    数据可以良好的做到阶段内无丢失（该阶段是开发者或运维人员手工维护的），且恢复速度较快，阶段 点数据恢复通常采用<code>RDB</code>方案 </li>
<li>​    注意：利用<code>RDB</code>实现紧凑的数据持久化会使<code>Redis</code>降的很低，慎重总结： </li>
</ul>
</li>
<li><strong>综合比对</strong> <ul>
<li>​    <code>RDB</code>与<code>AOF</code>的选择实际上是在做一种权衡，每种都有利有弊 </li>
<li>​    如不能承受数分钟以内的数据丢失，对业务数据非常敏感，选用<code>AOF</code> </li>
<li>​    如能承受数分钟以内的数据丢失，且追求大数据集的恢复速度，选用<code>RDB </code></li>
<li>​    灾难恢复选用<code>RDB</code> </li>
<li>​    双保险策略，同时开启 <code>RDB</code> 和<code> AOF</code>，重启后，<code>Redis</code>优先使用 <code>AOF</code> 来恢复数据，降低丢失数据的量</li>
</ul>
</li>
</ul>
<h2 id="持久化应用场景"><a href="#持久化应用场景" class="headerlink" title="持久化应用场景"></a>持久化应用场景</h2><p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221012160408015.png" srcset="/img/loading.gif" lazyload alt="image-20221012160408015"></p>
<h1 id="Redis-事务"><a href="#Redis-事务" class="headerlink" title="Redis 事务"></a>Redis 事务</h1><h2 id="事务简介"><a href="#事务简介" class="headerlink" title="事务简介"></a>事务简介</h2><p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221012161432189.png" srcset="/img/loading.gif" lazyload alt="image-20221012161432189"></p>
<p><strong>什么是事务</strong></p>
<p>Redis执行指令过程中，多条连续执行的指令被干扰，打断，插队</p>
<p>redis事务就是一个命令执行的队列，将一系列预定义命令包装成一个整体（一个队列）。当执行时，一次性 按照添加顺序依次执行，中间不会被打断或者干扰。</p>
<p>一个队列中，一次性、顺序性、排他性的执行一系列命令</p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221012161628529.png" srcset="/img/loading.gif" lazyload alt="image-20221012161628529"></p>
<h2 id="事务基本操作"><a href="#事务基本操作" class="headerlink" title="事务基本操作"></a>事务基本操作</h2><p><strong>事务的边界</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221012161728903.png" srcset="/img/loading.gif" lazyload alt="image-20221012161728903"></p>
<ul>
<li><strong>开启事务</strong></li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">multi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li><strong>作用</strong> </li>
</ul>
<p>​        设定事务的开启位置，此指令执行后，后续的所有指令均加入到事务中</p>
<ul>
<li><strong>执行事务</strong></li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">exec</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><strong>注意：加入事务的命令暂时进入到任务队列中，并没有立即执行，只有执行<code>exec</code>命令才开始执行</strong></p>
<p><strong>演示</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> MULTI
OK
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> <span class="token function">set</span> name 111
QUEUED
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> get name 
QUEUED
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> <span class="token function">set</span> name 222
QUEUED
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> get name
QUEUED
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> EXEC
1<span class="token punctuation">)</span> OK
2<span class="token punctuation">)</span> <span class="token string">"111"</span>
3<span class="token punctuation">)</span> OK
4<span class="token punctuation">)</span> <span class="token string">"222"</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><strong>事务定义过程中发现出了问题，怎么办？</strong></p>
<p>取消事务</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">discard<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>作用 </p>
<p>​    终止当前事务的定义，发生在<code>multi</code>之后，<code>exec</code>之前</p>
<p><strong>演示</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> MULTI
OK
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> <span class="token function">set</span> name 111
QUEUED
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> DISCARD
OK
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> EXEC
<span class="token punctuation">(</span>error<span class="token punctuation">)</span> ERR EXEC without MULTI
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h2 id="事务的工作流程"><a href="#事务的工作流程" class="headerlink" title="事务的工作流程"></a>事务的工作流程</h2><p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221012165810588.png" srcset="/img/loading.gif" lazyload alt="image-20221012165810588"></p>
<h2 id="事务的注意事项"><a href="#事务的注意事项" class="headerlink" title="事务的注意事项"></a>事务的注意事项</h2><p><strong>定义事务的过程中，命令格式输入错误怎么办？</strong></p>
<ul>
<li><strong>语法错误</strong> </li>
</ul>
<p>​    指命令书写格式有误 </p>
<ul>
<li><strong>处理结果</strong> </li>
</ul>
<p>​    如果定义的事务中所包含的命令存在语法错误，整体事务中所有命令均不会执行。包括那些语法正    确的命令。</p>
<p><strong>演示</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> MULTI
OK
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> <span class="token function">SET</span> name 111
QUEUED
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> TES name 222
<span class="token punctuation">(</span>error<span class="token punctuation">)</span> ERR unknown command <span class="token string">'TES'</span>
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> EXEC
<span class="token punctuation">(</span>error<span class="token punctuation">)</span> EXECABORT Transaction discarded because of previous errors<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><strong>定义事务的过程中，命令执行出现错误怎么办？</strong></p>
<ul>
<li><strong>运行错误</strong> </li>
</ul>
<p>​    指命令格式正确，但是无法正确的执行。例如对<code>list</code>进行<code>incr</code>操作 </p>
<ul>
<li><strong>处理结果</strong> </li>
</ul>
<p>​    能够正确运行的命令会执行，运行错误的命令不会被执行</p>
<p><strong>注意：已经执行完毕的命令对应的数据不会自动回滚，需要程序员自己在代码中实现回滚。</strong></p>
<p><strong>演示</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> MULTI
OK
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> <span class="token function">set</span> name 111
QUEUED
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> get name 
QUEUED
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> <span class="token function">set</span> name 222
QUEUED
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> get name
QUEUED
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> lpush name 1 2 3
QUEUED
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> EXEC
1<span class="token punctuation">)</span> OK
2<span class="token punctuation">)</span> <span class="token string">"111"</span>
3<span class="token punctuation">)</span> OK
4<span class="token punctuation">)</span> <span class="token string">"222"</span>
5<span class="token punctuation">)</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> WRONGTYPE Operation against a key holding the wrong kind of value
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h2 id="手动进行事务回滚"><a href="#手动进行事务回滚" class="headerlink" title="手动进行事务回滚"></a>手动进行事务回滚</h2><ul>
<li>记录操作过程中被影响的数据之前的状态 <ul>
<li>​    单数据：string </li>
<li>​    多数据：hash、list、set、zset </li>
</ul>
</li>
<li>设置指令恢复所有的被修改的项 <ul>
<li>​    单数据：直接set（注意周边属性，例如时效） </li>
<li>​    多数据：修改对应值或整体克隆复制</li>
</ul>
</li>
</ul>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221012181836503.png" srcset="/img/loading.gif" lazyload alt="image-20221012181836503"></p>
<h1 id="Redis-锁"><a href="#Redis-锁" class="headerlink" title="Redis 锁"></a>Redis 锁</h1><h2 id="基于特定条件的事务执行——锁"><a href="#基于特定条件的事务执行——锁" class="headerlink" title="基于特定条件的事务执行——锁"></a>基于特定条件的事务执行——锁</h2><p><strong>业务场景</strong></p>
<p>天猫双11热卖过程中，对已经售罄的货物追加补货，4个业务员都有权限进行补货。补货的操作可能是一系 列的操作，牵扯到多个连续操作，如何保障不会重复操作？</p>
<p><strong>业务分析</strong></p>
<ul>
<li>多个客户端有可能同时操作同一组数据，并且该数据一旦被操作修改后，将不适用于继续操作 </li>
<li>在操作之前锁定要操作的数据，一旦发生变化，终止当前操作</li>
</ul>
<p><strong>解决方案</strong></p>
<ul>
<li>对 <code>key</code> 添加监视锁，在执行<code>exec</code>前如果<code>key</code>发生了变化，终止事务执行</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">watch</span> key1 <span class="token punctuation">[</span>key2……<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li>取消对所有 key 的监视</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">unwatch<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>Tips 18：  <code>redis </code>应用基于状态控制的批量任务执行</p>
<p><strong>演示1.监控时 锁未被修改</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> FLUSHDB
OK
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> 
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> keys <span class="token operator">*</span>
<span class="token punctuation">(</span>empty list or <span class="token function">set</span><span class="token punctuation">)</span>
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> 
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> <span class="token function">set</span> name 123
OK
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> <span class="token function">set</span> age 321
OK
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> watch name
OK
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> get name
<span class="token string">"123"</span>
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> MULTI
OK
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> <span class="token function">set</span> aa bb
QUEUED
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> get aa
QUEUED
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> EXEC
1<span class="token punctuation">)</span> OK
2<span class="token punctuation">)</span> <span class="token string">"bb"</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><strong>演示2.监控时 锁被修改</strong></p>
<p><strong>客户端1</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> watch name age
OK
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> MULTI
OK
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> <span class="token function">set</span> aa cc
QUEUED
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> get aa
QUEUED<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><strong>客户端2</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell"><span class="token namespace">[root@hecs-33111 ~]</span><span class="token comment"># redis-cli -p 6379</span>
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> 
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> 
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> 
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> <span class="token function">set</span> name 111
OK<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><strong>客户端1</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> 
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> watch name age
OK
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> MULTI
OK
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> <span class="token function">set</span> aa cc
QUEUED
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> get aa
QUEUED
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> EXEC
<span class="token punctuation">(</span>nil<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><strong>演示3.事务必须在监视内部开启</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> MULTI
OK
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> WATCH age
<span class="token punctuation">(</span>error<span class="token punctuation">)</span> ERR WATCH inside MULTI is not allowed<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><strong>演示4.取消锁</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> WATCH name
OK
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> get name
<span class="token string">"111"</span>
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> UNWATCH
OK<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h2 id="基于特定条件的事务执行——分布式锁"><a href="#基于特定条件的事务执行——分布式锁" class="headerlink" title="基于特定条件的事务执行——分布式锁"></a>基于特定条件的事务执行——分布式锁</h2><p><strong>业务场景</strong></p>
<p>天猫双11热卖过程中，对已经售罄的货物追加补货，且补货完成。客户购买热情高涨，3秒内将所有商品购 买完毕。本次补货已经将库存全部清空，如何避免最后一件商品不被多人同时购买？【超卖问题】</p>
<p><strong>业务分析</strong></p>
<ul>
<li>使用<code>watch</code>监控一个<code>key</code>有没有改变已经不能解决问题，此处要监控的是具体数据 </li>
<li>虽然<code>redis</code>是单线程的，但是多个客户端对同一数据同时进行操作时，如何避免不被同时修改？</li>
</ul>
<p><strong>解决方案</strong></p>
<ul>
<li>使用 setnx 设置一个公共锁</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">setnx lock-key value<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p> 利用<code>setnx</code>命令的返回值特征，有值则返回设置失败，无值则返回设置成功 </p>
<ul>
<li>​    对于返回设置成功的，拥有控制权，进行下一步的具体业务操作 </li>
<li>​    对于返回设置失败的，不具有控制权，排队或等待<br>操作完毕通过del操作释放锁</li>
</ul>
<p>注意：上述解决方案是一种设计概念，依赖规范保障，具有风险性</p>
<p>Tips 19：  <code>redis</code> 应用基于分布式锁对应的场景控制</p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221013125505629.png" srcset="/img/loading.gif" lazyload alt="image-20221013125505629"></p>
<p><strong>演示</strong></p>
<p><strong>客户端1加锁并修改目标变量</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> <span class="token function">set</span> num 10
OK
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> 
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> SETNX <span class="token function">lock-num</span> 1
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> INCRBY num <span class="token operator">-</span>1
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 9<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><strong>客户端2也进行加锁，加锁失败</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> SETNX <span class="token function">lock-num</span> 1
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p><strong>客户端1删除锁</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> <span class="token function">set</span> num 10
OK
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> 
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> SETNX <span class="token function">lock-num</span> 1
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> INCRBY num <span class="token operator">-</span>1
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 9
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> <span class="token function">DEL</span> <span class="token function">lock-num</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><strong>客户端2加锁成功</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> SETNX <span class="token function">lock-num</span> 1
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> SETNX <span class="token function">lock-num</span> 1
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h2 id="基于特定条件的事务执行——分布式锁改良"><a href="#基于特定条件的事务执行——分布式锁改良" class="headerlink" title="基于特定条件的事务执行——分布式锁改良"></a>基于特定条件的事务执行——分布式锁改良</h2><p><strong>业务场景</strong></p>
<p>依赖分布式锁的机制，某个用户操作时对应客户端宕机，且此时已经获取到锁。如何解决？</p>
<p><strong>业务分析</strong></p>
<ul>
<li>由于锁操作由用户控制加锁解锁，必定会存在加锁后未解锁的风险 </li>
<li>需要解锁操作不能仅依赖用户控制，系统级别要给出对应的保底处理方案</li>
</ul>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221013131128283.png" srcset="/img/loading.gif" lazyload alt="image-20221013131128283"></p>
<p><strong>解决方案</strong></p>
<ul>
<li>使用 <code>expire</code> 为锁<code>key</code>添加时间限定，到时不释放，放弃锁</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">expire lock-key second
pexpire lock-key milliseconds<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p>由于操作通常都是微秒或毫秒级，因此该锁定时间不宜设置过大。具体时间需要业务测试后确认。 </p>
<ul>
<li>例如：持有锁的操作最长执行时间<code>127ms</code>，最短执行时间<code>7ms</code>。 </li>
<li>测试百万次最长执行时间对应命令的最大耗时，测试百万次网络延迟平均耗时 </li>
<li>锁时间设定推荐：最大耗时<code>*120%+平均网络延迟*110%</code> </li>
<li>如果<code>业务最大耗时&lt;&lt;网络平均延迟</code>，通常为<code>2个数量级</code>，取其中单个耗时较长即可</li>
</ul>
<p><strong>演示</strong></p>
<p><strong>客户端1，加锁并设置过期时间</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> SETNX <span class="token function">lock-num</span> 1
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> EXPIRE <span class="token function">lock-num</span> 20
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><strong>客户端2，尝试加锁</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> SETNX <span class="token function">lock-num</span> 1
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> SETNX <span class="token function">lock-num</span> 1
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> SETNX <span class="token function">lock-num</span> 1
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> SETNX <span class="token function">lock-num</span> 1
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> SETNX <span class="token function">lock-num</span> 1
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> SETNX <span class="token function">lock-num</span> 1
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> SETNX <span class="token function">lock-num</span> 1
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h1 id="Redis-删除策略"><a href="#Redis-删除策略" class="headerlink" title="Redis 删除策略"></a>Redis 删除策略</h1><h2 id="Redis中的数据特征"><a href="#Redis中的数据特征" class="headerlink" title="Redis中的数据特征"></a>Redis中的数据特征</h2><ul>
<li><p><code>Redis</code>是一种内存级数据库，所有数据均存放在内存中，内存中的数据可以通过<code>TTL</code>指令获取其状态 </p>
<ul>
<li><p><code>XX</code> ：具有时效性的数据 </p>
</li>
<li><p><code>-1</code> ：永久有效的数据 </p>
</li>
<li><p><code>-2</code> ：已经过期的数据 或 被删除的数据 或 未定义的数据</p>
</li>
</ul>
</li>
</ul>
<p><strong>过期的数据真的删除了吗？</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221013144136576.png" srcset="/img/loading.gif" lazyload alt="image-20221013144136576"></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221013144200317.png" srcset="/img/loading.gif" lazyload alt="image-20221013144200317"></p>
<h2 id="数据删除策略"><a href="#数据删除策略" class="headerlink" title="数据删除策略"></a>数据删除策略</h2><ol>
<li><strong>定时删除</strong></li>
<li><strong>惰性删除</strong></li>
<li><strong>定期删除</strong></li>
</ol>
<h3 id="时效性数据的存储结构"><a href="#时效性数据的存储结构" class="headerlink" title="时效性数据的存储结构"></a>时效性数据的存储结构</h3><p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221013144754957.png" srcset="/img/loading.gif" lazyload alt="image-20221013144754957"></p>
<h3 id="数据删除策略的目标"><a href="#数据删除策略的目标" class="headerlink" title="数据删除策略的目标"></a>数据删除策略的目标</h3><p>在内存占用与<code>CPU</code>占用之间寻找一种平衡，顾此失彼都会造成整体<code>redis</code>性能的下降，甚至引发<code>服务器宕机</code>或<code>内存泄露</code></p>
<h3 id="定时删除"><a href="#定时删除" class="headerlink" title="定时删除"></a>定时删除</h3><ul>
<li>创建一个定时器，当<code>key</code>设置有过期时间，且过期时间到达时，由定时器任务立即执行对键的删除操作 </li>
<li>优点：节约内存，到时就删除，快速释放掉不必要的内存占用 </li>
<li>缺点：<code>CPU</code>压力很大，无论<code>CPU</code>此时负载量多高，均占用<code>CPU</code>，会影响<code>redis</code>服务器响应时间和指令吞吐量 </li>
<li>总结：用处理器性能换取存储空间（拿时间换空间）</li>
</ul>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221013145837784.png" srcset="/img/loading.gif" lazyload alt="image-20221013145837784"></p>
<h3 id="惰性删除"><a href="#惰性删除" class="headerlink" title="惰性删除"></a>惰性删除</h3><ul>
<li>数据到达过期时间，不做处理。等下次访问该数据时 <ul>
<li>如果未过期，返回数据 </li>
<li>发现已过期，删除，返回不存在 </li>
</ul>
</li>
<li>优点：节约CPU性能，发现必须删除的时候才删除 </li>
<li>缺点：内存压力很大，出现长期占用内存的数据 </li>
<li>总结：用存储空间换取处理器性能 （拿时间换空间）</li>
</ul>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221013150235170.png" srcset="/img/loading.gif" lazyload alt="image-20221013150235170"></p>
<h3 id="定期删除"><a href="#定期删除" class="headerlink" title="定期删除"></a>定期删除</h3><p><strong>两种方案都走极端，有没有折中方案？</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221013151212923.png" srcset="/img/loading.gif" lazyload alt="image-20221013151212923"></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221013151238928.png" srcset="/img/loading.gif" lazyload alt="image-20221013151238928"></p>
<ul>
<li>周期性轮询<code>redis</code>库中的时效性数据，采用随机抽取的策略，利用过期数据占比的方式控制删除频度 </li>
<li>特点1：<code>CPU</code>性能占用设置有峰值，检测频度可自定义设置 </li>
<li>特点2：内存压力不是很大，长期占用内存的冷数据会被持续清理 </li>
<li>总结：周期性抽查存储空间 <code>expireIfNeeded()</code> （随机抽查，重点抽查）</li>
</ul>
<h3 id="删除策略比对"><a href="#删除策略比对" class="headerlink" title="删除策略比对"></a>删除策略比对</h3><p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221013151547838.png" srcset="/img/loading.gif" lazyload alt="image-20221013151547838"></p>
<h2 id="逐出算法"><a href="#逐出算法" class="headerlink" title="逐出算法"></a>逐出算法</h2><h3 id="新数据进入检测"><a href="#新数据进入检测" class="headerlink" title="新数据进入检测"></a>新数据进入检测</h3><p>当新数据进入redis时，如果内存不足怎么办？</p>
<ul>
<li><code>Redis</code>使用内存存储数据，在执行每一个命令前，会调用<code>freeMemoryIfNeeded()</code>检测内存是否充足。如 果内存不满足新加入数据的最低存储要求，redis要临时删除一些数据为当前指令清理存储空间。清理数据 的策略称为逐出算法。 </li>
<li>注意：逐出数据的过程不是<code>100%</code>能够清理出足够的可使用的内存空间，如果不成功则反复执行。当对所 有数据尝试完毕后，如果不能达到内存清理的要求，将出现错误信息。</li>
</ul>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221014131638733.png" srcset="/img/loading.gif" lazyload alt="image-20221014131638733"></p>
<h3 id="影响数据逐出的相关配置"><a href="#影响数据逐出的相关配置" class="headerlink" title="影响数据逐出的相关配置"></a>影响数据逐出的相关配置</h3><ul>
<li>最大可使用内存</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">maxmemory<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>占用物理内存的比例，默认值为0，表示不限制。生产环境中根据需求设定，通常设置在50%以上。</p>
<ul>
<li>每次选取待删除数据的个数</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">maxmemory-samples<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>选取数据时并不会全库扫描，导致严重的性能消耗，降低读写性能。因此采用随机获取数据的方式作为待检测删除数据</p>
<ul>
<li>删除策略</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">maxmemory-policy<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>达到最大内存后的，对被挑选出来的数据进行删除的策略</p>
<p> 检测易失数据（可能会过期的数据集<code>server.db[i].expires</code> ） </p>
<p>① <code>volatile-lru</code>：挑选最近最少使用的数据淘汰 </p>
<p>② <code>volatile-lfu</code>：挑选最近使用次数最少的数据淘汰 </p>
<p>③ <code>volatile-ttl</code>：挑选将要过期的数据淘汰 </p>
<p>④ <code>volatile-random</code>：任意选择数据淘汰 </p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221014132248229.png" srcset="/img/loading.gif" lazyload alt="image-20221014132248229"></p>
<p> 检测全库数据（所有数据集<code>server.db[i].dict </code>） </p>
<p>⑤ <code>allkeys-lru</code>：挑选最近最少使用的数据淘汰 </p>
<p>⑥ <code>allkeys-lfu</code>：挑选最近使用次数最少的数据淘汰 </p>
<p>⑦ <code>allkeys-random</code>：任意选择数据淘汰 </p>
<p> 放弃数据驱逐 </p>
<p>⑧ <code>no-enviction</code>（驱逐）：禁止驱逐数据（<code>redis4.0</code>中默认策略），会引发错误<code>OOM（Out Of Memory）</code></p>
<p><strong>命令配置</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">maxmemory-policy volatile-lru<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<h3 id="数据逐出策略配置依据"><a href="#数据逐出策略配置依据" class="headerlink" title="数据逐出策略配置依据"></a>数据逐出策略配置依据</h3><p>使用<code>INFO</code>命令输出监控信息，查询缓存 <code>hit</code> 和 <code>miss</code> 的次数，根据业务需求调优<code>Redis</code>配置</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> INFO<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221014133100016.png" srcset="/img/loading.gif" lazyload alt="image-20221014133100016"></p>
<h1 id="Redis-核心配置"><a href="#Redis-核心配置" class="headerlink" title="Redis 核心配置"></a>Redis 核心配置</h1><h2 id="服务器端设定"><a href="#服务器端设定" class="headerlink" title="服务器端设定"></a>服务器端设定</h2><ul>
<li>设置服务器以守护进程的方式运行</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">daemonize yes<span class="token punctuation">|</span>no<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li>绑定主机地址</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">bind 127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li>设置服务器端口号</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">port 6379<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li>设置数据库数量</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">databases 16<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<h2 id="日志配置"><a href="#日志配置" class="headerlink" title="日志配置"></a>日志配置</h2><ul>
<li>设置服务器以指定日志记录级别</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">loglevel debug<span class="token punctuation">|</span>verbose<span class="token punctuation">|</span>notice<span class="token punctuation">|</span>warning<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li>日志记录文件名</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">logfile 端口号.log<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>注意：日志级别开发期设置为<code>verbose</code>即可，生产环境中配置为<code>notice</code>，简化日志输出量，降低写日志IO的频度</p>
<h2 id="客户端配置"><a href="#客户端配置" class="headerlink" title="客户端配置"></a>客户端配置</h2><ul>
<li>设置同一时间最大客户端连接数，默认无限制。当客户端连接到达上限，Redis会关闭新的连接</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">maxclients 0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li>客户端闲置等待最大时长，达到最大值后关闭连接。如需关闭该功能，设置为 0</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">timeout 300<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<h2 id="多服务器快捷配置"><a href="#多服务器快捷配置" class="headerlink" title="多服务器快捷配置"></a>多服务器快捷配置</h2><p>导入并加载指定配置文件信息，用于快速创建<code>redis</code>公共配置较多的<code>redis</code>实例配置文件，便于维护</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">include /path/server-端口号.conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<h1 id="Redis-高级数据类型"><a href="#Redis-高级数据类型" class="headerlink" title="Redis 高级数据类型"></a>Redis 高级数据类型</h1><h2 id="Bitmaps"><a href="#Bitmaps" class="headerlink" title="Bitmaps"></a>Bitmaps</h2><p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221014134814217.png" srcset="/img/loading.gif" lazyload alt="image-20221014134814217"></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221014134931474.png" srcset="/img/loading.gif" lazyload alt="image-20221014134931474"></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221014135302634.png" srcset="/img/loading.gif" lazyload alt="image-20221014135302634"></p>
<h3 id="Bitmaps类型的基础操作"><a href="#Bitmaps类型的基础操作" class="headerlink" title="Bitmaps类型的基础操作"></a>Bitmaps类型的基础操作</h3><ul>
<li>获取指定key对应偏移量上的bit值</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">getbit key offset<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li>设置指定key对应偏移量上的bit值，value只能是1或0</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">setbit key offset value<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><strong>演示</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> SETBIT bits 0 1
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> GETBIT bits 0
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> GETBIT bits 10
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="Bitmaps类型的扩展操作"><a href="#Bitmaps类型的扩展操作" class="headerlink" title="Bitmaps类型的扩展操作"></a>Bitmaps类型的扩展操作</h3><p><strong>业务场景</strong> </p>
<p><strong>电影网站</strong> </p>
<ul>
<li>统计每天某一部电影是否被点播 </li>
<li>统计每天有多少部电影被点播 </li>
<li>统计每周/月/年有多少部电影被点播 </li>
<li>统计年度哪部电影没有被点播</li>
</ul>
<p><strong>业务分析</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221014140142843.png" srcset="/img/loading.gif" lazyload alt="image-20221014140142843"></p>
<ul>
<li>对指定key按位进行交、并、非、异或操作，并将结果保存到destKey中</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">bitop op destKey key1 [key2...]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li><p>and：交 </p>
</li>
<li><p>or：并 </p>
</li>
<li><p>not：非 </p>
</li>
<li><p>xor：异或</p>
</li>
<li><p>统计指定key中1的数量</p>
</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">bitcount key <span class="token punctuation">[</span>start end<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>Tips 21： <code>redis</code> 应用于信息状态统计</p>
<p><strong>演示</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> SETBIT 20880808 0 1
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> SETBIT 20880808 4 1
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> SETBIT 20880808 8 1
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> SETBIT 20880809 0 1
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> SETBIT 20880809 5 1
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> SETBIT 20880809 8 1
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> BITCOUNT 20880808
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 3
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> BITCOUNT 20880809
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 3
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> SETBIT  20880808 6 1
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> BITCOUNT 20880808
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 4
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> BITOP or 08-09 20880808 20880809
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 2
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> BITCOUNT 08-09
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 5
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h2 id="HyperLogLog"><a href="#HyperLogLog" class="headerlink" title="HyperLogLog"></a>HyperLogLog</h2><h3 id="统计独立UV"><a href="#统计独立UV" class="headerlink" title="统计独立UV"></a>统计独立UV</h3><ul>
<li>原始方案：set <ul>
<li>存储每个用户的id（字符串） </li>
</ul>
</li>
<li>改进方案：Bitmaps <ul>
<li>存储每个用户状态（bit） </li>
</ul>
</li>
<li>全新的方案：Hyperloglog</li>
</ul>
<h3 id="基数"><a href="#基数" class="headerlink" title="基数"></a>基数</h3><ul>
<li>基数是数据集去重后元素个数 </li>
<li><code>HyperLogLog</code> 是用来做基数统计的，运用了<code>LogLog</code>的算法</li>
</ul>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221014142336498.png" srcset="/img/loading.gif" lazyload alt="image-20221014142336498"></p>
<h3 id="HyperLogLog类型的基本操作"><a href="#HyperLogLog类型的基本操作" class="headerlink" title="HyperLogLog类型的基本操作"></a>HyperLogLog类型的基本操作</h3><ul>
<li>添加数据</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pfadd key element <span class="token punctuation">[</span>element <span class="token punctuation">..</span>.<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li>统计数据</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pfcount key <span class="token punctuation">[</span>key <span class="token punctuation">..</span>.<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li>合并数据</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pfmerge destkey sourcekey <span class="token punctuation">[</span>sourcekey<span class="token punctuation">..</span>.<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>Tips 22：  redis 应用于独立信息统计</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> PFADD hll 001
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> PFADD hll 001
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> PFADD hll 001
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> PFADD hll 001
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> PFADD hll 001
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> PFADD hll 002
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> GET hll
"HYLL<span class="token punctuation">\</span>x01<span class="token punctuation">\</span>x00<span class="token punctuation">\</span>x00<span class="token punctuation">\</span>x00<span class="token punctuation">\</span>x00<span class="token punctuation">\</span>x00<span class="token punctuation">\</span>x00<span class="token punctuation">\</span>x00<span class="token punctuation">\</span>x00<span class="token punctuation">\</span>x00<span class="token punctuation">\</span>x00<span class="token punctuation">\</span>x80L<span class="token punctuation">\</span>x9f<span class="token punctuation">\</span>x84R<span class="token punctuation">\</span>xbf<span class="token punctuation">\</span>x80`<span class="token punctuation">\</span>x9d"
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> PFCOUNT hll
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">2</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">redis<span class="token operator">></span> PFADD  nosql  <span class="token string">"Redis"</span>  <span class="token string">"MongoDB"</span>  <span class="token string">"Memcached"</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span>
redis<span class="token operator">></span> PFADD  RDBMS  <span class="token string">"MySQL"</span> <span class="token string">"MSSQL"</span> <span class="token string">"PostgreSQL"</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span>
redis<span class="token operator">></span> PFMERGE  databases  nosql  RDBMS
OK
redis<span class="token operator">></span> PFCOUNT  databases
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">6</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>



<h3 id="相关说明"><a href="#相关说明" class="headerlink" title="相关说明"></a>相关说明</h3><ul>
<li>用于进行基数统计，不是集合，不保存数据，只记录数量而不是具体数据 </li>
<li>核心是基数估算算法，最终数值<strong>存在一定误差</strong> </li>
<li>误差范围：基数估计的结果是一个带有 <code>0.81%</code> 标准错误的近似值 </li>
<li>耗空间极小，每个<code>hyperloglog key</code>占用了<code>12K</code>的内存用于标记基数 </li>
<li><code>pfadd</code>命令不是一次性分配<code>12K</code>内存使用，会随着基数的增加内存逐渐增大 </li>
<li><code>Pfmerge</code>命令合并后占用的存储空间为<code>12K</code>，无论合并之前数据量多少</li>
</ul>
<h2 id="GEO"><a href="#GEO" class="headerlink" title="GEO"></a>GEO</h2><p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221014162507268.png" srcset="/img/loading.gif" lazyload alt="image-20221014162507268"></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221014162532151.png" srcset="/img/loading.gif" lazyload alt="image-20221014162532151"></p>
<h3 id="GEO类型的基本操作"><a href="#GEO类型的基本操作" class="headerlink" title="GEO类型的基本操作"></a>GEO类型的基本操作</h3><ul>
<li><strong>添加坐标点</strong></li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">geoadd key longitude latitude member <span class="token punctuation">[</span>longitude latitude member <span class="token punctuation">..</span>.<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li><strong>获取坐标点</strong></li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">geopos key member <span class="token punctuation">[</span>member <span class="token punctuation">..</span>.<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li><strong>计算坐标点距离</strong></li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">geodist key member1 member2 <span class="token punctuation">[</span>unit<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><strong>演示</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> GEOADD geos 1 1 a
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> GEOADD geos 2 2 b
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> GEOPOS geos a
1<span class="token punctuation">)</span> 1<span class="token punctuation">)</span> <span class="token string">"0.99999994039535522"</span>
   2<span class="token punctuation">)</span> <span class="token string">"0.99999945914297683"</span>
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> GEODIST geos a b
<span class="token string">"157270.0561"</span>
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> GEODIST geos a b m
<span class="token string">"157270.0561"</span>
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> GEODIST geos a b km
<span class="token string">"157.2701"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>


<ul>
<li><strong>根据坐标范围内的数据</strong></li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">georadius key longitude latitude radius m<span class="token operator">|</span>km<span class="token operator">|</span>ft<span class="token operator">|</span>mi <span class="token punctuation">[</span>withcoord<span class="token punctuation">]</span> <span class="token punctuation">[</span>withdist<span class="token punctuation">]</span> <span class="token punctuation">[</span>withhash<span class="token punctuation">]</span> <span class="token punctuation">[</span>count count<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li><strong>根据点求范围内数据</strong></li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">georadiusbymember key member radius m<span class="token operator">|</span>km<span class="token operator">|</span>ft<span class="token operator">|</span>mi <span class="token punctuation">[</span>withcoord<span class="token punctuation">]</span> <span class="token punctuation">[</span>withdist<span class="token punctuation">]</span> <span class="token punctuation">[</span>withhash<span class="token punctuation">]</span> <span class="token punctuation">[</span>count count<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li> <strong>计算经纬度</strong></li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">geohash key member <span class="token punctuation">[</span>member <span class="token punctuation">..</span>.<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><strong>演示</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> GEODIST geos a b
<span class="token string">"157270.0561"</span>
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> GEODIST geos a b m
<span class="token string">"157270.0561"</span>
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> GEODIST geos a b km
<span class="token string">"157.2701"</span>
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> GEOADD geos 1 1 1<span class="token punctuation">,</span>1
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> GEOADD geos 1 2 1<span class="token punctuation">,</span>2
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> GEOADD geos 1 3 1<span class="token punctuation">,</span>3
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> GEOADD geos 2 1 2<span class="token punctuation">,</span>1
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> GEOADD geos 2 2 2<span class="token punctuation">,</span>2
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> GEOADD geos 2 3 2<span class="token punctuation">,</span>3
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> GEOADD geos 3 1 3<span class="token punctuation">,</span>1
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> GEOADD geos 3 2 3<span class="token punctuation">,</span>2
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> GEOADD geos 3 3 3<span class="token punctuation">,</span>3
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> GEOADD geos 5 5 5<span class="token punctuation">,</span>5
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> GEORADIUSBYMEMBER geos 2<span class="token punctuation">,</span>2 180 km
 1<span class="token punctuation">)</span> <span class="token string">"1,1"</span>
 2<span class="token punctuation">)</span> <span class="token string">"a"</span>
 3<span class="token punctuation">)</span> <span class="token string">"2,1"</span>
 4<span class="token punctuation">)</span> <span class="token string">"1,2"</span>
 5<span class="token punctuation">)</span> <span class="token string">"2,2"</span>
 6<span class="token punctuation">)</span> <span class="token string">"b"</span>
 7<span class="token punctuation">)</span> <span class="token string">"3,1"</span>
 8<span class="token punctuation">)</span> <span class="token string">"3,2"</span>
 9<span class="token punctuation">)</span> <span class="token string">"1,3"</span>
10<span class="token punctuation">)</span> <span class="token string">"2,3"</span>
11<span class="token punctuation">)</span> <span class="token string">"3,3"</span>
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> GEORADIUSBYMEMBER geos 2<span class="token punctuation">,</span>2 120 km
1<span class="token punctuation">)</span> <span class="token string">"1,2"</span>
2<span class="token punctuation">)</span> <span class="token string">"2,2"</span>
3<span class="token punctuation">)</span> <span class="token string">"b"</span>
4<span class="token punctuation">)</span> <span class="token string">"2,3"</span>
5<span class="token punctuation">)</span> <span class="token string">"2,1"</span>
6<span class="token punctuation">)</span> <span class="token string">"3,2"</span>
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> GEORADIUSBYMEMBER geos 2<span class="token punctuation">,</span>2 1800 km
 1<span class="token punctuation">)</span> <span class="token string">"1,1"</span>
 2<span class="token punctuation">)</span> <span class="token string">"a"</span>
 3<span class="token punctuation">)</span> <span class="token string">"2,1"</span>
 4<span class="token punctuation">)</span> <span class="token string">"1,2"</span>
 5<span class="token punctuation">)</span> <span class="token string">"2,2"</span>
 6<span class="token punctuation">)</span> <span class="token string">"b"</span>
 7<span class="token punctuation">)</span> <span class="token string">"3,1"</span>
 8<span class="token punctuation">)</span> <span class="token string">"3,2"</span>
 9<span class="token punctuation">)</span> <span class="token string">"1,3"</span>
10<span class="token punctuation">)</span> <span class="token string">"2,3"</span>
11<span class="token punctuation">)</span> <span class="token string">"3,3"</span>
12<span class="token punctuation">)</span> <span class="token string">"5,5"</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> GEORADIUS geos 1<span class="token punctuation">.</span>5 1<span class="token punctuation">.</span>5 90 km
1<span class="token punctuation">)</span> <span class="token string">"1,2"</span>
2<span class="token punctuation">)</span> <span class="token string">"2,2"</span>
3<span class="token punctuation">)</span> <span class="token string">"b"</span>
4<span class="token punctuation">)</span> <span class="token string">"1,1"</span>
5<span class="token punctuation">)</span> <span class="token string">"a"</span>
6<span class="token punctuation">)</span> <span class="token string">"2,1"</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:6379> GEOHASH geos 2<span class="token punctuation">,</span>2
1<span class="token punctuation">)</span> <span class="token string">"s037ms06g70"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p>Tips 23：  redis 应用于地理位置计算</p>
<h1 id="Redis-主从复制"><a href="#Redis-主从复制" class="headerlink" title="Redis 主从复制"></a>Redis 主从复制</h1><h2 id="主从复制简介"><a href="#主从复制简介" class="headerlink" title="主从复制简介"></a>主从复制简介</h2><p><strong>互联网“三高”架构</strong></p>
<ul>
<li><strong>高并发</strong> </li>
<li><strong>高性能</strong> </li>
<li><strong>高可用</strong></li>
</ul>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221017163836418.png" srcset="/img/loading.gif" lazyload alt="image-20221017163836418"></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221017163847015.png" srcset="/img/loading.gif" lazyload alt="image-20221017163847015"></p>
<h3 id="你的“Redis”是否高可用"><a href="#你的“Redis”是否高可用" class="headerlink" title="你的“Redis”是否高可用"></a><strong>你的“Redis”是否高可用</strong></h3><p>单机<code>redis</code>的风险与问题 </p>
<ul>
<li>问题1.机器故障 <ul>
<li>现象：硬盘故障、系统崩溃 </li>
<li>本质：数据丢失，很可能对业务造成灾难性打击 </li>
<li>结论：基本上会放弃使用<code>redis</code>. </li>
</ul>
</li>
<li>问题2.容量瓶颈 <ul>
<li>现象：内存不足，从<code>16G</code>升级到<code>64G</code>，从<code>64G</code>升级到<code>128G</code>，无限升级内存 </li>
<li>本质：穷，硬件条件跟不上 </li>
<li>结论：放弃使用<code>redis</code> </li>
</ul>
</li>
<li>结论： <ul>
<li>​    为了避免单点<code>Redis</code>服务器故障，准备多台服务器，互相连通。将数据复制多个副本保存在不同的服 务器上，<strong>连接在一起</strong>，并保证数据是<strong>同步</strong>的。即使有其中一台服务器宕机，其他服务器依然可以继续 提供服务，实现<code>Redis</code>的高可用，同时实现数据<strong>冗余备份</strong>。</li>
</ul>
</li>
</ul>
<h3 id="多台服务器连接方案"><a href="#多台服务器连接方案" class="headerlink" title="多台服务器连接方案"></a>多台服务器连接方案</h3><ul>
<li>提供数据方：master <ul>
<li>主服务器，主节点，主库 </li>
<li>主客户端 </li>
</ul>
</li>
<li>接收数据方：slave <ul>
<li>从服务器，从节点，从库 </li>
<li>从客户端 </li>
</ul>
</li>
<li>需要解决的问题：<ul>
<li> 数据同步 </li>
</ul>
</li>
<li>核心工作： <ul>
<li>master的数据复制到slave中</li>
</ul>
</li>
</ul>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221017164832371.png" srcset="/img/loading.gif" lazyload alt="image-20221017164832371"></p>
<h3 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a>主从复制</h3><p>主从复制即将<code>master</code>中的数据即时、有效的复制到<code>slave</code>中 </p>
<p>特征：一个<code>master</code>可以拥有多个<code>slave</code>，一个<code>slave</code>只对应一个<code>master </code></p>
<p>职责： </p>
<ul>
<li><strong>master</strong>: <ul>
<li>写数据 </li>
<li>执行写操作时，将出现变化的数据自动同步到<code>slave </code></li>
<li>读数据（可忽略） </li>
</ul>
</li>
<li><strong>slave</strong>: <ul>
<li>读数据 </li>
<li>写数据（禁止）</li>
</ul>
</li>
</ul>
<h3 id="高可用集群"><a href="#高可用集群" class="headerlink" title="高可用集群"></a>高可用集群</h3><p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221017165447946.png" srcset="/img/loading.gif" lazyload alt="image-20221017165447946"></p>
<h3 id="主从复制的作用"><a href="#主从复制的作用" class="headerlink" title="主从复制的作用"></a>主从复制的作用</h3><ul>
<li>读写分离：<code>master</code>写、<code>slave</code>读，提高服务器的读写负载能力 </li>
<li>负载均衡：基于主从结构，配合读写分离，由<code>slave</code>分担<code>master</code>负载，并根据需求的变化，改变<code>slave</code>的数 量，通过多个从节点分担数据读取负载，大大提高<code>Redis</code>服务器并发量与数据吞吐量 </li>
<li>故障恢复：当<code>master</code>出现问题时，由<code>slave</code>提供服务，实现快速的故障恢复 </li>
<li>数据冗余：实现数据热备份，是持久化之外的一种数据冗余方式 </li>
<li>高可用基石：基于主从复制，构建哨兵模式与集群，实现<code>Redis</code>的高可用方案</li>
</ul>
<h2 id="主从复制工作流程"><a href="#主从复制工作流程" class="headerlink" title="主从复制工作流程"></a>主从复制工作流程</h2><ul>
<li><p>主从复制过程大体可以分为3个阶段 </p>
<ul>
<li><p> <strong>建立连接阶段（即准备阶段）</strong> </p>
</li>
<li><p> <strong>数据同步阶段</strong> </p>
</li>
<li><p> <strong>命令传播阶段</strong></p>
</li>
</ul>
</li>
</ul>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221017200718612.png" srcset="/img/loading.gif" lazyload alt="image-20221017200718612"></p>
<h3 id="阶段一：建立连接阶段"><a href="#阶段一：建立连接阶段" class="headerlink" title="阶段一：建立连接阶段"></a>阶段一：建立连接阶段</h3><p>建立<code>slave</code>到<code>master</code>的连接，使<code>master</code>能够识别<code>slave</code>，并保存<code>slave</code>端口号</p>
<h4 id="建立连接阶段工作流程"><a href="#建立连接阶段工作流程" class="headerlink" title="建立连接阶段工作流程"></a>建立连接阶段工作流程</h4><p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221017201122179.png" srcset="/img/loading.gif" lazyload alt="image-20221017201122179"></p>
<h4 id="主从连接（slave连接master）"><a href="#主从连接（slave连接master）" class="headerlink" title="主从连接（slave连接master）"></a>主从连接（slave连接master）</h4><ul>
<li><strong>方式一：客户端发送命令</strong></li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">slaveof &lt;masterip> &lt;masterport><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li><strong>方式二：启动服务器参数</strong></li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">redis-server <span class="token operator">-</span>slaveof &lt;masterip> &lt;masterport><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li><strong>方式三：服务器配置</strong></li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">slaveof &lt;masterip> &lt;masterport><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li><p><code>slave</code>系统信息</p>
<ul>
<li><p>master_link_down_since_seconds </p>
</li>
<li><p>masterhost </p>
</li>
<li><p>masterport</p>
</li>
</ul>
</li>
<li><p><code>master</code>系统信息</p>
<ul>
<li>slave_listening_port(多个)</li>
</ul>
</li>
</ul>
<p><strong>演示</strong></p>
<ul>
<li><strong>修改配置文件关闭守护进程和日志</strong></li>
</ul>
<p><strong>redis-6379.conf</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">port</span> <span class="token value attr-value">6379</span>
<span class="token key attr-name">daemonize</span> <span class="token value attr-value">no</span>
<span class="token comment">#logfile "6379.log"</span>
<span class="token key attr-name">dir</span> <span class="token value attr-value">/root/redis-4.0.0/data</span>
<span class="token key attr-name">dbfilename</span> <span class="token value attr-value">dump-6379.rdb</span>
<span class="token key attr-name">rdbcompression</span> <span class="token value attr-value">yes</span>
<span class="token key attr-name">rdbchecksum</span> <span class="token value attr-value">yes</span>
<span class="token key attr-name">save</span> <span class="token value attr-value">10 2</span>
<span class="token key attr-name">appendonly</span> <span class="token value attr-value">yes</span>
<span class="token key attr-name">appendfsync</span> <span class="token value attr-value">always</span>
<span class="token key attr-name">appendfilename</span> <span class="token value attr-value">appendonly-6379.aof</span>
<span class="token key attr-name">bind</span> <span class="token value attr-value">127.0.0.1</span>
<span class="token key attr-name">databases</span> <span class="token value attr-value">16</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><strong>redis-6380.conf</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">port</span> <span class="token value attr-value">6380</span>
<span class="token key attr-name">daemonize</span> <span class="token value attr-value">no</span>
<span class="token comment">#logfile "6380.log"</span>
<span class="token key attr-name">dir</span> <span class="token value attr-value">/root/redis-4.0.0/data</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<ul>
<li><strong>启动多个redis服务</strong></li>
</ul>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221017202520833.png" srcset="/img/loading.gif" lazyload alt="image-20221017202520833"></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221017202628618.png" srcset="/img/loading.gif" lazyload alt="image-20221017202628618"></p>
<ul>
<li><strong>slave服务器连接master服务器</strong></li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@hecs-33111 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -p 6380</span>
<span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">0</span>></span> 
<span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">0</span>></span> 
<span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">0</span>></span> SLAVEOF <span class="token number">127.0</span>.0.1 <span class="token number">6379</span>
OK<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221017203447084.png" srcset="/img/loading.gif" lazyload alt="image-20221017203447084"></p>
<p><strong>观察服务器连接信息</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221017203710563.png" srcset="/img/loading.gif" lazyload alt="image-20221017203710563"></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221017203741205.png" srcset="/img/loading.gif" lazyload alt="image-20221017203741205"></p>
<p><strong>同步效果测试</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221017204007153.png" srcset="/img/loading.gif" lazyload alt="image-20221017204007153"></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221017204029344.png" srcset="/img/loading.gif" lazyload alt="image-20221017204029344"></p>
<p><strong>第二种连接方式(启动时连接)</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@hecs-33111 redis-4.0.0<span class="token punctuation">]</span><span class="token comment"># redis-server conf/redis-6380.conf --slaveof 127.0.0.1 6379</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><strong>第三种连接方式（配置文件连接）</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">port</span> <span class="token value attr-value">6380</span>
<span class="token key attr-name">daemonize</span> <span class="token value attr-value">no</span>
<span class="token comment">#logfile "6380.log"</span>
<span class="token key attr-name">dir</span> <span class="token value attr-value">/root/redis-4.0.0/data</span>
<span class="token key attr-name">slaveof</span> <span class="token value attr-value">127.0.0.1 6379</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><strong>查看信息</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">info<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221017204901267.png" srcset="/img/loading.gif" lazyload alt="image-20221017204901267"></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221017204924813.png" srcset="/img/loading.gif" lazyload alt="image-20221017204924813"></p>
<h4 id="主从断开连接"><a href="#主从断开连接" class="headerlink" title="主从断开连接"></a>主从断开连接</h4><ul>
<li>客户端发送命令</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">slaveof no one<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>说明： </p>
<ul>
<li>​    <code>slave</code>断开连接后，不会删除已有数据，只是不再接受<code>master</code>发送的数据</li>
</ul>
<h4 id="授权访问"><a href="#授权访问" class="headerlink" title="授权访问"></a>授权访问</h4><ul>
<li><code>master</code>客户端发送命令设置密码</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">requirepass <span class="token operator">&lt;</span>password<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li><code>master</code>配置文件设置密码</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">config <span class="token builtin class-name">set</span> requirepass <span class="token operator">&lt;</span>password<span class="token operator">></span>
config get requirepass<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<ul>
<li><code>slave</code>客户端发送命令设置密码</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">auth <span class="token operator">&lt;</span>password<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li>slave配置文件设置密码</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">masterauth <span class="token operator">&lt;</span>password<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li>slave启动服务器设置密码</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">redis-server –a <span class="token operator">&lt;</span>password<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<h3 id="阶段二：数据同步阶段工作流程"><a href="#阶段二：数据同步阶段工作流程" class="headerlink" title="阶段二：数据同步阶段工作流程"></a>阶段二：数据同步阶段工作流程</h3><ul>
<li>在<code>slave</code>初次连接<code>master</code>后，复制<code>master</code>中的所有数据到<code>slave </code></li>
<li>将<code>slave</code>的数据库状态更新成<code>master</code>当前的数据库状态</li>
</ul>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221017212932073.png" srcset="/img/loading.gif" lazyload alt="image-20221017212932073"></p>
<h4 id="数据同步阶段master说明"><a href="#数据同步阶段master说明" class="headerlink" title="数据同步阶段master说明"></a>数据同步阶段master说明</h4><ol>
<li>如果<code>master</code>数据量巨大，数据同步阶段应避开流量高峰期，避免造成<code>master</code>阻塞，影响业务正常执行 </li>
<li>复制缓冲区大小设定不合理，会导致数据溢出。如进行全量复制周期太长，进行部分复制时发现数据已 经存在丢失的情况，必须进行第二次全量复制，致使<code>slave</code>陷入死循环状态。</li>
</ol>
<figure><div class="code-wrapper"><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">repl-backlog-size</span> <span class="token value attr-value">1mb</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ol start="3">
<li><code>master</code>单机内存占用主机内存的比例不应过大，建议使用<code>50%-70%</code>的内存，留下<code>30%-50%</code>的内存用于执 行<code>bgsave</code>命令和创建复制缓冲区</li>
</ol>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221017213705310.png" srcset="/img/loading.gif" lazyload alt="image-20221017213705310"></p>
<h4 id="数据同步阶段slave说明"><a href="#数据同步阶段slave说明" class="headerlink" title="数据同步阶段slave说明"></a>数据同步阶段slave说明</h4><ol>
<li>为避免<code>slave</code>进行全量复制、部分复制时服务器响应阻塞或数据不同步，建议关闭此期间的对外服务</li>
</ol>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">slave-serve-stale-data <span class="token function">yes</span><span class="token operator">|</span>no<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ol start="2">
<li>数据同步阶段，<code>master</code>发送给<code>slave</code>信息可以理解<code>master</code>是<code>slave</code>的一个客户端，主动向<code>slave</code>发送 命令 </li>
<li>多个<code>slave</code>同时对<code>master</code>请求数据同步，<code>master</code>发送的<code>RDB</code>文件增多，会对带宽造成巨大冲击，如果 <code>master</code>带宽不足，因此数据同步需要根据业务需求，适量错峰</li>
<li><code>slave</code>过多时，建议调整拓扑结构，由一主多从结构变为树状结构，中间的节点既是<code>master</code>，也是 <code>slave</code>。注意使用树状结构时，由于层级深度，导致深度越高的<code>slave</code>与最顶层<code>master</code>间数据同步延迟 较大，数据一致性变差，应谨慎选择</li>
</ol>
<h3 id="阶段三：命令传播阶段"><a href="#阶段三：命令传播阶段" class="headerlink" title="阶段三：命令传播阶段"></a>阶段三：命令传播阶段</h3><ul>
<li>当<code>master</code>数据库状态被修改后，导致主从服务器数据库状态不一致，此时需要让主从数据同步到一致的 状态，同步的动作称为命令传播 </li>
<li><code>master</code>将接收到的数据变更命令发送给<code>slave</code>，<code>slave</code>接收命令后执行命令 </li>
<li>主从复制过程大体可以分为3个阶段 <ul>
<li><strong>建立连接阶段（即准备阶段）</strong> </li>
<li><strong>数据同步阶段</strong> </li>
<li><strong>命令传播阶段</strong></li>
</ul>
</li>
</ul>
<h4 id="命令传播阶段的部分复制"><a href="#命令传播阶段的部分复制" class="headerlink" title="命令传播阶段的部分复制"></a>命令传播阶段的部分复制</h4><p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221017214240292.png" srcset="/img/loading.gif" lazyload alt="image-20221017214240292"></p>
<h4 id="服务器运行ID（runid）"><a href="#服务器运行ID（runid）" class="headerlink" title="服务器运行ID（runid）"></a>服务器运行ID（runid）</h4><ul>
<li>概念：服务器运行ID是每一台服务器每次运行的身份识别码，一台服务器多次运行可以生成多个运行id </li>
<li>组成：运行id由40位字符组成，是一个随机的十六进制字符 例如：fdc9ff13b9bbaab28db42b3d50f852bb5e3fcdce </li>
<li>作用：运行id被用于在服务器间进行传输，识别身份 如果想两次操作均对同一台服务器进行，必须每次操作携带对应的运行id，用于对方识别 </li>
<li>实现方式：运行id在每台服务器启动时自动生成的，master在首次连接slave时，会将自己的运行ID发 送给slave，slave保存此ID，通过info Server命令，可以查看节点的runid</li>
</ul>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221017214743888.png" srcset="/img/loading.gif" lazyload alt="image-20221017214743888"></p>
<h4 id="复制缓冲区"><a href="#复制缓冲区" class="headerlink" title="复制缓冲区"></a>复制缓冲区</h4><p>概念：复制缓冲区，又名复制积压缓冲区，是一个先进先出<code>（FIFO）</code>的队列，用于存储服务器执行过的命 令，每次传播命令，<code>master</code>都会将传播的命令记录下来，并存储在复制缓冲区</p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221017214956086.png" srcset="/img/loading.gif" lazyload alt="image-20221017214956086"></p>
<h4 id="复制缓冲区内部工作原理"><a href="#复制缓冲区内部工作原理" class="headerlink" title="复制缓冲区内部工作原理"></a>复制缓冲区内部工作原理</h4><p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221018164806918.png" srcset="/img/loading.gif" lazyload alt="image-20221018164806918"></p>
<ul>
<li>概念：复制缓冲区，又名复制积压缓冲区，是一个先进先出<code>（FIFO）</code>的队列，用于存储服务器执行过的命 令，每次传播命令，<code>master</code>都会将传播的命令记录下来，并存储在复制缓冲区 <ul>
<li>复制缓冲区默认数据存储空间大小是<code>1M</code>，由于存储空间大小是固定的，当入队元素的数量大于队 列长度时，最先入队的元素会被弹出，而新元素会被放入队列 </li>
</ul>
</li>
<li>由来：每台服务器启动时，如果开启有<code>AOF</code>或被连接成为<code>master</code>节点，即创建复制缓冲区 </li>
<li>作用：用于保存<code>master</code>收到的所有指令（仅影响数据变更的指令，例如<code>set，select</code>） </li>
<li>数据来源：当<code>master</code>接收到主客户端的指令时，除了将指令执行，会将该指令存储到缓冲区中</li>
</ul>
<h4 id="主从服务器复制偏移量（offset）"><a href="#主从服务器复制偏移量（offset）" class="headerlink" title="主从服务器复制偏移量（offset）"></a>主从服务器复制偏移量（offset）</h4><ul>
<li>概念：一个数字，描述复制缓冲区中的指令字节位置 </li>
<li>分类： <ul>
<li><code>master</code>复制偏移量：记录发送给所有<code>slave</code>的指令字节对应的位置（多个） </li>
<li><code>slave</code>复制偏移量：记录<code>slave</code>接收<code>master</code>发送过来的指令字节对应的位置（一个） </li>
</ul>
</li>
<li>数据来源： <ul>
<li><code>master</code>端：发送一次记录一次 </li>
<li><code>slave</code>端：接收一次记录一次 </li>
</ul>
</li>
<li>作用：同步信息，比对<code>master</code>与<code>slave</code>的差异，当<code>slave</code>断线后，恢复数据使用</li>
</ul>
<h4 id="数据同步-命令传播阶段工作流程"><a href="#数据同步-命令传播阶段工作流程" class="headerlink" title="数据同步+命令传播阶段工作流程"></a>数据同步+命令传播阶段工作流程</h4><p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221018165949891.png" srcset="/img/loading.gif" lazyload alt="image-20221018165949891"></p>
<h4 id="心跳机制"><a href="#心跳机制" class="headerlink" title="心跳机制"></a>心跳机制</h4><ul>
<li>进入命令传播阶段候，<code>master</code>与<code>slave</code>间需要进行信息交换，使用心跳机制进行维护，实现双方连接保持在线 </li>
<li><code>master</code>心跳： <ul>
<li>指令：PING </li>
<li>周期：由<code>repl-ping-slave-period</code>决定，默认10秒 </li>
<li>作用：判断<code>slave</code>是否在线 </li>
<li>查询：INFO replication 获取slave最后一次连接时间间隔，<code>lag</code>项维持在0或1视为正常 </li>
</ul>
</li>
<li>slave心跳任务 <ul>
<li>指令：REPLCONF ACK {offset} </li>
<li>周期：1秒 </li>
<li>作用1：汇报<code>slave</code>自己的复制偏移量，获取最新的数据变更指令 </li>
<li>作用2：判断<code>master</code>是否在线</li>
</ul>
</li>
</ul>
<h4 id="心跳阶段注意事项"><a href="#心跳阶段注意事项" class="headerlink" title="心跳阶段注意事项"></a>心跳阶段注意事项</h4><ul>
<li>当<code>slave</code>多数掉线，或延迟过高时，<code>master</code>为保障数据稳定性，将拒绝所有信息同步操作</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">min-slaves-to-write</span> <span class="token value attr-value">2</span>
<span class="token key attr-name">min-slaves-max-lag</span> <span class="token value attr-value">8</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p><code>slave</code>数量少于2个，或者所有<code>slave</code>的延迟都大于等于10秒时，强制关闭<code>master</code>写功能，停止数据同步</p>
<ul>
<li><code>slave</code>数量由<code>slave</code>发送<code>REPLCONF ACK</code>命令做确认 </li>
<li><code>slave</code>延迟由<code>slave</code>发送<code>REPLCONF ACK</code>命令做确认</li>
</ul>
<h4 id="主从复制工作流程（完整）"><a href="#主从复制工作流程（完整）" class="headerlink" title="主从复制工作流程（完整）"></a>主从复制工作流程（完整）</h4><p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221018171711366.png" srcset="/img/loading.gif" lazyload alt="image-20221018171711366"></p>
<h2 id="主从复制常见问题"><a href="#主从复制常见问题" class="headerlink" title="主从复制常见问题"></a>主从复制常见问题</h2><h3 id="频繁的全量复制（1）"><a href="#频繁的全量复制（1）" class="headerlink" title="频繁的全量复制（1）"></a>频繁的全量复制（1）</h3><p>伴随着系统的运行，<code>master</code>的数据量会越来越大，一旦<code>master</code>重启，<code>runid</code>将发生变化，会导致全部<code>slave</code>的 全量复制操作 </p>
<p>内部优化调整方案： </p>
<ol>
<li><code>master</code>内部创建<code>master_replid</code>变量，使用<code>runid</code>相同的策略生成，长度<code>41</code>位，并发送给所有slave </li>
<li>在<code>master</code>关闭时执行命令 <code>shutdown save</code>，进行<code>RDB</code>持久化,将<code>runid</code>与<code>offset</code>保存到RDB文件中 <ul>
<li>repl-id repl-offset  </li>
<li>通过<code>redis-check-rdb</code>命令可以查看该信息 </li>
</ul>
</li>
<li><code>master</code>重启后加载<code>RDB</code>文件，恢复数据 <ul>
<li>重启后，将<code>RDB</code>文件中保存的<code>repl-id</code>与<code>repl-offset</code>加载到内存中 <ul>
<li>master_repl_id = repl master_repl_offset = repl-offset </li>
<li>通过<code>info</code>命令可以查看该信息 </li>
</ul>
</li>
</ul>
</li>
</ol>
<p>作用： 本机保存上次<code>runid</code>，重启后恢复该值，使所有<code>slave</code>认为还是之前的<code>master</code></p>
<h3 id="频繁的全量复制（2）"><a href="#频繁的全量复制（2）" class="headerlink" title="频繁的全量复制（2）"></a>频繁的全量复制（2）</h3><ul>
<li>问题现象 <ul>
<li>网络环境不佳，出现网络中断，<code>slave</code>不提供服务 </li>
</ul>
</li>
<li>问题原因 <ul>
<li>复制缓冲区过小，断网后<code>slave</code>的<code>offset</code>越界，触发全量复制 </li>
</ul>
</li>
<li>最终结果 <ul>
<li><code>slave</code>反复进行全量复制 </li>
</ul>
</li>
<li>解决方案 <ul>
<li>修改复制缓冲区大小</li>
</ul>
</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties">repl-backlog-size<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li>建议设置如下</li>
</ul>
<ol>
<li>测算从<code>master</code>到<code>slave</code>的重连平均时长<code>second </code></li>
<li>获取<code>master</code>平均每秒产生写命令数据总量<code>write_size_per_second </code></li>
<li>最优复制缓冲区空间 = <code>2 * second * write_size_per_second</code></li>
</ol>
<h3 id="频繁的网络中断（1）"><a href="#频繁的网络中断（1）" class="headerlink" title="频繁的网络中断（1）"></a>频繁的网络中断（1）</h3><ul>
<li>问题现象 <ul>
<li><code>master</code>的<code>CPU</code>占用过高 或 <code>slave</code>频繁断开连接 </li>
</ul>
</li>
<li>问题原因 <ul>
<li><code>slave</code>每1秒发送<code>REPLCONF ACK</code>命令到<code>master </code></li>
<li>当<code>slave</code>接到了慢查询时（<code>keys *</code> ，<code>hgetall</code>等），会大量占用<code>CPU</code>性能 </li>
<li><code>master</code>每1秒调用复制定时函数r<code>eplicationCron()</code>，比对<code>slave</code>发现长时间没有进行响应 </li>
</ul>
</li>
<li>最终结果 <ul>
<li><code>master</code>各种资源（输出缓冲区、带宽、连接等）被严重占用 </li>
</ul>
</li>
<li>解决方案 <ul>
<li>通过设置合理的超时时间，确认是否释放<code>slave</code></li>
</ul>
</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties">repl-timeout<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>该参数定义了超时时间的阈值（默认<code>60秒</code>），超过该值，释放<code>slave</code></p>
<h3 id="频繁的网络中断（2）"><a href="#频繁的网络中断（2）" class="headerlink" title="频繁的网络中断（2）"></a>频繁的网络中断（2）</h3><ul>
<li>问题现象 <ul>
<li><code>slave</code>与<code>master</code>连接断开 </li>
</ul>
</li>
<li>问题原因 <ul>
<li><code>master</code>发送<code>ping</code>指令频度较低 </li>
<li><code>master</code>设定超时时间较短 </li>
<li><code>ping</code>指令在网络中存在丢包 </li>
</ul>
</li>
<li>解决方案 <ul>
<li>提高<code>ping</code>指令发送的频度</li>
</ul>
</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties">repl-ping-slave-period<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>超时时间<code>repl-time</code>的时间至少是<code>ping</code>指令频度的5到10倍，否则<code>slave</code>很容易判定超时</p>
<h3 id="数据不一致"><a href="#数据不一致" class="headerlink" title="数据不一致"></a>数据不一致</h3><ul>
<li>问题现象 <ul>
<li>多个<code>slave</code>获取相同数据不同步 </li>
</ul>
</li>
<li>问题原因 <ul>
<li>网络信息不同步，数据发送有延迟 </li>
</ul>
</li>
<li>解决方案 <ul>
<li>优化主从间的网络环境，通常放置在同一个机房部署，如使用阿里云等云服务器时要注意此现象 </li>
<li>监控主从节点延迟（通过<code>offset</code>）判断，如果<code>slave</code>延迟过大，暂时屏蔽程序对该<code>slave</code>的数据访问</li>
</ul>
</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">slave-serve-stale-data</span> <span class="token value attr-value">yes|no</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>开启后仅响应<code>info</code>、<code>slaveof</code>等少数命令（慎用，除非对数据一致性要求很高）</p>
<h1 id="Redis-哨兵模式"><a href="#Redis-哨兵模式" class="headerlink" title="Redis 哨兵模式"></a><strong>Redis 哨兵模式</strong></h1><h2 id="哨兵简介"><a href="#哨兵简介" class="headerlink" title="哨兵简介"></a>哨兵简介</h2><p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221018182810865.png" srcset="/img/loading.gif" lazyload alt="image-20221018182810865"></p>
<p><strong>哨兵</strong></p>
<p>哨兵(sentinel) 是一个分布式系统，用于对主从结构中的每台服务器进行<strong>监控</strong>，当出现故障时通过投票机制<strong>选择</strong>新的 <code>master</code>并将所有<code>slave</code>连接到新的<code>master</code>。</p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221018182922458.png" srcset="/img/loading.gif" lazyload alt="image-20221018182922458"></p>
<p><strong>哨兵的作用</strong></p>
<ul>
<li>监控 <ul>
<li>不断的检查<code>master</code>和<code>slave</code>是否正常运行。 </li>
<li><code>master</code>存活检测、<code>master</code>与<code>slave</code>运行情况检测 </li>
</ul>
</li>
<li>通知（提醒） <ul>
<li>当被监控的服务器出现问题时，向其他（哨兵间，客户端）发送通知。 </li>
</ul>
</li>
<li>自动故障转移 <ul>
<li>断开<code>master</code>与<code>slave</code>连接，选取一个<code>slave</code>作为<code>master</code>，将其他<code>slave</code>连接到新的<code>master</code>，并告知客户端新的服 务器地址 </li>
</ul>
</li>
</ul>
<p>注意： 哨兵也是一台<code>redis</code>服务器，只是不提供数据服务 通常哨兵配置数量为单数</p>
<h2 id="配置哨兵"><a href="#配置哨兵" class="headerlink" title="配置哨兵"></a>配置哨兵</h2><ul>
<li>配置一拖二的主从结构 </li>
<li>配置三个哨兵（配置相同，端口不同） <ul>
<li>参看<code>sentinel.conf </code></li>
</ul>
</li>
<li>启动哨兵</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">redis-sentinel</span> <span class="token value attr-value">sentinel-端口号.conf</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><strong>演示</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221018211141094.png" srcset="/img/loading.gif" lazyload alt="image-20221018211141094"></p>
<p><strong>观察文件信息</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">[root@hecs-33111</span> <span class="token value attr-value">redis-4.0.0]# cat sentinel.conf | grep -v "#" | grep -v "^$"</span>
<span class="token key attr-name">port</span> <span class="token value attr-value">26379</span>
<span class="token key attr-name">dir</span> <span class="token value attr-value">/tmp</span>
<span class="token key attr-name">sentinel</span> <span class="token value attr-value">monitor mymaster 127.0.0.1 6379 2</span>
<span class="token key attr-name">sentinel</span> <span class="token value attr-value">down-after-milliseconds mymaster 30000</span>
<span class="token key attr-name">sentinel</span> <span class="token value attr-value">parallel-syncs mymaster 1</span>
<span class="token key attr-name">sentinel</span> <span class="token value attr-value">failover-timeout mymaster 180000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><strong>将配置文件拷贝一份至指定文件夹下</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> sentinel.conf <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token string">"#"</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token string">"^$"</span> <span class="token operator">></span> ./conf/sentinel-26379.conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221018211919137.png" srcset="/img/loading.gif" lazyload alt="image-20221018211919137"></p>
<p><strong>修改配置文件</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221018212228270.png" srcset="/img/loading.gif" lazyload alt="image-20221018212228270"></p>
<p><strong>再拷贝两份哨兵的配置文件</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@hecs-33111 conf<span class="token punctuation">]</span><span class="token comment"># sed 's/26379/26380/g' sentinel-26379.conf > sentinel-26380.conf </span>
<span class="token punctuation">[</span>root@hecs-33111 conf<span class="token punctuation">]</span><span class="token comment"># sed 's/26379/26381/g' sentinel-26379.conf > sentinel-26381.conf </span>
<span class="token punctuation">[</span>root@hecs-33111 conf<span class="token punctuation">]</span><span class="token comment"># cat sentinel-26380.conf </span>
port <span class="token number">26380</span>
<span class="token function">dir</span> /root/redis-4.0.0/data
sentinel monitor mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6379</span> <span class="token number">2</span>
sentinel down-after-milliseconds mymaster <span class="token number">30000</span>
sentinel parallel-syncs mymaster <span class="token number">1</span>
sentinel failover-timeout mymaster <span class="token number">180000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><strong>再拷贝一份slave的配置</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@hecs-33111 conf<span class="token punctuation">]</span><span class="token comment"># sed 's/6380/6381/g' redis-6380.conf > redis-6381.conf</span>
<span class="token punctuation">[</span>root@hecs-33111 conf<span class="token punctuation">]</span><span class="token comment"># cat redis-6381.conf </span>
port <span class="token number">6381</span>
daemonize no
<span class="token comment">#logfile "6381.log"</span>
<span class="token function">dir</span> /root/redis-4.0.0/data
slaveof <span class="token number">127.0</span>.0.1 <span class="token number">6379</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><strong>清空data文件夹中的所有信息</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@hecs-33111 data<span class="token punctuation">]</span><span class="token comment"># rm -rf *</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><strong>启动master</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221018213515776.png" srcset="/img/loading.gif" lazyload alt="image-20221018213515776"></p>
<p><strong>启动两个slave</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221018213813008.png" srcset="/img/loading.gif" lazyload alt="image-20221018213813008"></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221018213903729.png" srcset="/img/loading.gif" lazyload alt="image-20221018213903729"></p>
<p><strong>启动哨兵1</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">redis-sentinel  conf/sentinel-26379.conf <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221018214102909.png" srcset="/img/loading.gif" lazyload alt="image-20221018214102909"></p>
<p><strong>客户端连接哨兵1观察信息</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@hecs-33111 /<span class="token punctuation">]</span><span class="token comment"># redis-cli -p 26379</span>
<span class="token number">127.0</span>.0.1:2637<span class="token operator"><span class="token file-descriptor important">9</span>></span> info<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221018214557474.png" srcset="/img/loading.gif" lazyload alt="image-20221018214557474"></p>
<p><strong>观察配置文件 已经发生变化</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221018214924564.png" srcset="/img/loading.gif" lazyload alt="image-20221018214924564"></p>
<p><strong>启动哨兵2</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221018215154820.png" srcset="/img/loading.gif" lazyload alt="image-20221018215154820"></p>
<p><strong>观察到哨兵1的相关信息</strong></p>
<p><strong>观察哨兵1的日志信息可以观察到哨兵2的信息</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221018215320585.png" srcset="/img/loading.gif" lazyload alt="image-20221018215320585"></p>
<p><strong>观察现有两个哨兵的配置文件信息</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221018215520080.png" srcset="/img/loading.gif" lazyload alt="image-20221018215520080"></p>
<p><strong>启动哨兵3</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221018215630899.png" srcset="/img/loading.gif" lazyload alt="image-20221018215630899"></p>
<p><strong>观察到识别出两个哨兵信息</strong></p>
<p><strong>观察哨兵1的配置文件 可以查看到新增哨兵信息</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221018215802938.png" srcset="/img/loading.gif" lazyload alt="image-20221018215802938"></p>
<p><strong>验证master与两个slave的连通性</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> <span class="token builtin class-name">set</span> name weishao
OK<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">0</span>></span> get name
<span class="token string">"weishao"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">1</span>></span> get name
<span class="token string">"weishao"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p><strong>CTRL+C使得master宕机</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221019151305171.png" srcset="/img/loading.gif" lazyload alt="image-20221019151305171"></p>
<p><strong>观察哨兵1的信息</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221019151729961.png" srcset="/img/loading.gif" lazyload alt="image-20221019151729961"></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221019151925079.png" srcset="/img/loading.gif" lazyload alt="image-20221019151925079"></p>
<h2 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h2><h3 id="主从切换"><a href="#主从切换" class="headerlink" title="主从切换"></a><strong>主从切换</strong></h3><ul>
<li>哨兵在进行主从切换过程中经历三个阶段 <ul>
<li>监控 </li>
<li>通知 </li>
<li>故障转移</li>
</ul>
</li>
</ul>
<h3 id="阶段一：监控阶段"><a href="#阶段一：监控阶段" class="headerlink" title="阶段一：监控阶段"></a>阶段一：监控阶段</h3><p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221019155153179.png" srcset="/img/loading.gif" lazyload alt="image-20221019155153179"></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221019202524994.png" srcset="/img/loading.gif" lazyload alt="image-20221019202524994"></p>
<h3 id="阶段二：通知阶段"><a href="#阶段二：通知阶段" class="headerlink" title="阶段二：通知阶段"></a>阶段二：通知阶段</h3><p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221019202725003.png" srcset="/img/loading.gif" lazyload alt="image-20221019202725003"></p>
<h3 id="阶段三：故障转移阶段"><a href="#阶段三：故障转移阶段" class="headerlink" title="阶段三：故障转移阶段"></a>阶段三：故障转移阶段</h3><p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221019203036948.png" srcset="/img/loading.gif" lazyload alt="image-20221019203036948"></p>
<p><strong>选择领头的sentine进行清理，选举过程</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221019203813171.png" srcset="/img/loading.gif" lazyload alt="image-20221019203813171"></p>
<p><strong>领头的sentinel选择新的slave作为master</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221019204608998.png" srcset="/img/loading.gif" lazyload alt="image-20221019204608998"></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>监控 <ul>
<li>同步信息 </li>
</ul>
</li>
<li>通知 <ul>
<li>保持联通 </li>
</ul>
</li>
<li>故障转移 <ul>
<li>发现问题 </li>
<li>竞选负责人 </li>
<li>优选新master </li>
<li>新<code>master</code>上任，其他<code>slave</code>切换<code>master</code>，原<code>master</code>作为<code>slave</code>故障回复后连接</li>
</ul>
</li>
</ul>
<h1 id="Redis-集群"><a href="#Redis-集群" class="headerlink" title="Redis 集群"></a>Redis 集群</h1><h2 id="集群简介"><a href="#集群简介" class="headerlink" title="集群简介"></a>集群简介</h2><p><strong>现状问题</strong></p>
<p><strong>业务发展过程中遇到的峰值瓶颈</strong></p>
<ul>
<li><code>redis</code>提供的服务<code>OPS</code>可以达到10万/秒，当前业务OPS已经达到10万/秒 </li>
<li>内存单机容量达到<code>256G</code>，当前业务需求内存容量<code>1T </code></li>
<li>使用集群的方式可以快速解决上述问题</li>
</ul>
<p><strong>集群架构</strong></p>
<p> 集群就是使用网络将若干台计算机联通起来，并提供统一的管理方式，使其对外呈现单机的服务效果</p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221019210603285.png" srcset="/img/loading.gif" lazyload alt="image-20221019210603285"></p>
<p><strong>集群作用</strong></p>
<ul>
<li>分散单台服务器的访问压力，实现负载均衡 </li>
<li>分散单台服务器的存储压力，实现可扩展性 </li>
<li>降低单台服务器宕机带来的业务灾难</li>
</ul>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221019210730122.png" srcset="/img/loading.gif" lazyload alt="image-20221019210730122"></p>
<h2 id="Redis集群结构设计"><a href="#Redis集群结构设计" class="headerlink" title="Redis集群结构设计"></a>Redis集群结构设计</h2><h3 id="数据存储设计"><a href="#数据存储设计" class="headerlink" title="数据存储设计"></a>数据存储设计</h3><p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221019211136036.png" srcset="/img/loading.gif" lazyload alt="image-20221019211136036"></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221019211257396.png" srcset="/img/loading.gif" lazyload alt="image-20221019211257396"></p>
<h3 id="集群内部通讯设计"><a href="#集群内部通讯设计" class="headerlink" title="集群内部通讯设计"></a>集群内部通讯设计</h3><p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221019211557357.png" srcset="/img/loading.gif" lazyload alt="image-20221019211557357"></p>
<h2 id="cluster集群搭建"><a href="#cluster集群搭建" class="headerlink" title="cluster集群搭建"></a>cluster集群搭建</h2><h3 id="搭建方式"><a href="#搭建方式" class="headerlink" title="搭建方式"></a>搭建方式</h3><ul>
<li>原生安装（单条命令） <ul>
<li>配置服务器（3主3从） </li>
<li>建立通信（Meet） </li>
<li>分槽（Slot） </li>
<li>搭建主从（master-slave） </li>
</ul>
</li>
<li>工具安装（批处理）</li>
</ul>
<h3 id="Cluster配置"><a href="#Cluster配置" class="headerlink" title="Cluster配置"></a>Cluster配置</h3><ul>
<li><p>添加节点</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">cluster-enabled</span> <span class="token value attr-value">yes|no</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>
</li>
<li><p>cluster配置文件名，该文件属于自动生成，仅用于快速查找文件并查询文件内容</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">cluster-config-file</span> <span class="token value attr-value">&lt;filename></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>
</li>
<li><p>节点服务响应超时时间，用于判定该节点是否下线或切换为从节点</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">cluster-node-timeout</span> <span class="token value attr-value">&lt;milliseconds></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>
</li>
<li><p>master连接的slave最小数量</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">cluster-migration-barrier</span> <span class="token value attr-value">&lt;count></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

</li>
</ul>
<h3 id="Cluster节点操作命令"><a href="#Cluster节点操作命令" class="headerlink" title="Cluster节点操作命令"></a>Cluster节点操作命令</h3><ul>
<li><p>查看集群节点信息</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">cluster nodes<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>
</li>
<li><p>进入一个从节点 redis，切换其主节点</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">cluster replicate <span class="token operator">&lt;</span>master-id<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>
</li>
<li><p>发现一个新节点，新增主节点</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">cluster meet ip:port<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>
</li>
<li><p>忽略一个没有solt的节点</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">cluster forget <span class="token operator">&lt;</span>id<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>
</li>
<li><p>手动故障转移</p>
  <figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">cluster failover<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

</li>
</ul>
<h3 id="redis-trib命令"><a href="#redis-trib命令" class="headerlink" title="redis-trib命令"></a>redis-trib命令</h3><ul>
<li><p>添加节点</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">redis-trib.rb add-node<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>
</li>
<li><p>删除节点</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">redis-trib.rb del-node<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>
</li>
<li><p>重新分片</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">redis-trib.rb reshard<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

</li>
</ul>
<h3 id="演示-1"><a href="#演示-1" class="headerlink" title="演示"></a><strong>演示</strong></h3><h4 id="搭建"><a href="#搭建" class="headerlink" title="搭建"></a>搭建</h4><p><strong>清空data</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@hecs-33111 data<span class="token punctuation">]</span><span class="token comment"># rm -rf *</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><strong>配置redis-6379集群的配置</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221019212827549.png" srcset="/img/loading.gif" lazyload alt="image-20221019212827549"></p>
<p><strong>复制配置文件为6份</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@hecs-33111 conf<span class="token punctuation">]</span><span class="token comment"># sed 's/6379/6380/g' redis-6379.conf >redis-6380.conf</span>
<span class="token punctuation">[</span>root@hecs-33111 conf<span class="token punctuation">]</span><span class="token comment"># sed 's/6379/6381/g' redis-6379.conf >redis-6381.conf</span>
<span class="token punctuation">[</span>root@hecs-33111 conf<span class="token punctuation">]</span><span class="token comment"># sed 's/6379/6382/g' redis-6379.conf >redis-6382.conf</span>
<span class="token punctuation">[</span>root@hecs-33111 conf<span class="token punctuation">]</span><span class="token comment"># sed 's/6379/6383/g' redis-6379.conf >redis-6383.conf</span>
<span class="token punctuation">[</span>root@hecs-33111 conf<span class="token punctuation">]</span><span class="token comment"># sed 's/6379/6384/g' redis-6379.conf >redis-6384.conf</span>
<span class="token punctuation">[</span>root@hecs-33111 conf<span class="token punctuation">]</span><span class="token comment"># sed 's/6379/6385/g' redis-6379.conf >redis-6385.conf</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><strong>根据配置文件依次启动redis-server</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@hecs-33111 redis-4.0.0<span class="token punctuation">]</span><span class="token comment"># redis-server conf/redis-6379.conf </span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221019213943319.png" srcset="/img/loading.gif" lazyload alt="image-20221019213943319"></p>
<p><strong>观察服务已经全部启动</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221019214204996.png" srcset="/img/loading.gif" lazyload alt="image-20221019214204996"></p>
<p><strong>观察启动命令</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221019215041069.png" srcset="/img/loading.gif" lazyload alt="image-20221019215041069"></p>
<p>执行此命令需要安装<code>ruby</code>和<code>ruby gem</code></p>
<p><strong>安装ruby</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> yum <span class="token function">install</span> ruby<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><strong>安装ruby gem</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">yum install rubygems -y<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><strong>查看ruby和ruby gem安装版本</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@hecs-33111 src<span class="token punctuation">]</span><span class="token comment"># ruby -v</span>
ruby <span class="token number">2.5</span>.9p229 <span class="token punctuation">(</span><span class="token number">2021</span>-04-05 revision <span class="token number">67939</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>x86_64-linux<span class="token punctuation">]</span>
<span class="token punctuation">[</span>root@hecs-33111 src<span class="token punctuation">]</span><span class="token comment"># gem -v</span>
<span class="token number">2.7</span>.6.3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><strong>启动集群</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@hecs-33111 src<span class="token punctuation">]</span><span class="token comment"># ./redis-trib.rb create --replicas 1 127.0.0.1:6379 127.0.0.1:6380 127.0.0.1:6381 127.0.0.1:6382 127.0.0.1:6383 127.0.0.1:6384</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><strong>报错</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221019221124005.png" srcset="/img/loading.gif" lazyload alt="image-20221019221124005"></p>
<p><strong>解决方案</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@hecs-33111 src<span class="token punctuation">]</span><span class="token comment"># gem install redis</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221019221255502.png" srcset="/img/loading.gif" lazyload alt="image-20221019221255502"></p>
<p><strong>观察到data目录下已经生成了一些配置文件</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020103923017.png" srcset="/img/loading.gif" lazyload alt="image-20221020103923017"></p>
<p><strong>观察6379的节点信息</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020104041099.png" srcset="/img/loading.gif" lazyload alt="image-20221020104041099"></p>
<p><strong>覆盖配置</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020104442095.png" srcset="/img/loading.gif" lazyload alt="image-20221020104442095"></p>
<p><strong>节点开始加入</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020104543307.png" srcset="/img/loading.gif" lazyload alt="image-20221020104543307"></p>
<p><strong>观察6379配置文件变化</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020104914459.png" srcset="/img/loading.gif" lazyload alt="image-20221020104914459"></p>
<p><strong>观察6379此时的日志信息</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020105340354.png" srcset="/img/loading.gif" lazyload alt="image-20221020105340354"></p>
<h4 id="设置与获取数据"><a href="#设置与获取数据" class="headerlink" title="设置与获取数据"></a><strong>设置与获取数据</strong></h4><p><strong>连接redis集群</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@hecs-33111 src<span class="token punctuation">]</span><span class="token comment"># redis-cli -c</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p><strong>设置数据</strong></p>
<p><strong>根据key计算出槽位，并且重定向至槽位</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020105938279.png" srcset="/img/loading.gif" lazyload alt="image-20221020105938279"></p>
<p><strong>连接集群内指定位置的redis服务器</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">redis-cli <span class="token parameter variable">-c</span> <span class="token parameter variable">-p</span> <span class="token number">6382</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@hecs-33111 src<span class="token punctuation">]</span><span class="token comment"># redis-cli -c -p 6382</span>
<span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">2</span>></span> 
<span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">2</span>></span> 
<span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">2</span>></span> 
<span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">2</span>></span> get name
-<span class="token operator">></span> Redirected to slot <span class="token punctuation">[</span><span class="token number">5798</span><span class="token punctuation">]</span> located at <span class="token number">127.0</span>.0.1:6380
<span class="token string">"itheima"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h4 id="主从下线与主从切换"><a href="#主从下线与主从切换" class="headerlink" title="主从下线与主从切换"></a><strong>主从下线与主从切换</strong></h4><p><strong>关闭slave1 观察master1日志信息</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020110725445.png" srcset="/img/loading.gif" lazyload alt="image-20221020110725445"></p>
<p><strong>其余redis服务器显示的信息</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020110909594.png" srcset="/img/loading.gif" lazyload alt="image-20221020110909594"></p>
<p><strong>将slave1恢复连接观察master1的信息</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020111001703.png" srcset="/img/loading.gif" lazyload alt="image-20221020111001703"></p>
<p><strong>关闭master1，观察slave1日志信息</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020111147479.png" srcset="/img/loading.gif" lazyload alt="image-20221020111147479"></p>
<p><strong>slave1替代master1成为新的master</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020111637321.png" srcset="/img/loading.gif" lazyload alt="image-20221020111637321"></p>
<p><strong>查看集群节点信息</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">0</span>></span> CLUSTER NODES<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020112004426.png" srcset="/img/loading.gif" lazyload alt="image-20221020112004426"></p>
<p><strong>恢复6379，观察日志信息</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020113758577.png" srcset="/img/loading.gif" lazyload alt="image-20221020113758577"></p>
<h1 id="Redis-企业级解决方案"><a href="#Redis-企业级解决方案" class="headerlink" title="Redis 企业级解决方案"></a>Redis 企业级解决方案</h1><h2 id="缓存预热"><a href="#缓存预热" class="headerlink" title="缓存预热"></a>缓存预热</h2><p><strong>“宕机”</strong></p>
<p>服务器启动后迅速宕机</p>
<p><strong>问题排查</strong></p>
<ol>
<li>请求数量较高 </li>
<li>主从之间数据吞吐量较大，数据同步操作频度较高</li>
</ol>
<p><strong>解决方案</strong></p>
<p><strong>前置准备工作</strong>： </p>
<ol>
<li><p>日常例行统计数据访问记录，统计访问频度较高的热点数据 </p>
</li>
<li><p>利用LRU数据删除策略，构建数据留存队列 例如：storm与kafka配合 </p>
<p><strong>准备工作</strong>： </p>
<ol>
<li><p>将统计结果中的数据分类，根据级别，redis优先加载级别较高的热点数据 </p>
</li>
<li><p>利用分布式多服务器同时进行数据读取，提速数据加载过程 </p>
</li>
<li><p>热点数据主从同时预热 </p>
<p><strong>实施</strong>： </p>
<ol>
<li>使用脚本程序固定触发数据预热过程 </li>
<li>如果条件允许，使用了CDN（内容分发网络），效果会更好</li>
</ol>
</li>
</ol>
</li>
</ol>
<p><strong>总结</strong></p>
<p>缓存预热就是系统启动前，提前将相关的缓存数据直接加载到缓存系统。避免在用户请求的时候，先查询数据库，然后再将数据缓 存的问题！用户直接查询事先被预热的缓存数据！</p>
<h2 id="缓存雪崩"><a href="#缓存雪崩" class="headerlink" title="缓存雪崩"></a>缓存雪崩</h2><p><strong>数据库服务器崩溃（1）</strong></p>
<ol>
<li>系统平稳运行过程中，忽然数据库连接量激增 </li>
<li>应用服务器无法及时处理请求 </li>
<li>大量408，500错误页面出现 </li>
<li>客户反复刷新页面获取数据 </li>
<li>数据库崩溃 </li>
<li>应用服务器崩溃 </li>
<li>重启应用服务器无效 </li>
<li>Redis服务器崩溃 </li>
<li>Redis集群崩溃 </li>
<li>重启数据库后再次被瞬间流量放倒</li>
</ol>
<p><strong>问题排查</strong></p>
<ol>
<li>在一个较短的时间内，缓存中较多的key集中过期 </li>
<li>此周期内请求访问过期的数据，redis未命中，redis向数据库获取数据 </li>
<li>数据库同时接收到大量的请求无法及时处理 </li>
<li>Redis大量请求被积压，开始出现超时现象 </li>
<li>数据库流量激增，数据库崩溃 </li>
<li>重启后仍然面对缓存中无数据可用 </li>
<li>Redis服务器资源被严重占用，Redis服务器崩溃 </li>
<li>Redis集群呈现崩塌，集群瓦解 </li>
<li>应用服务器无法及时得到数据响应请求，来自客户端的请求数量越来越多，应用服务器崩溃 </li>
<li>应用服务器，redis，数据库全部重启，效果不理想</li>
</ol>
<p><strong>问题分析</strong></p>
<ul>
<li>短时间范围内 </li>
<li>大量key集中过期</li>
</ul>
<p><strong>解决方案（道）</strong></p>
<ol>
<li><p><strong>更多的页面静态化处理</strong> </p>
</li>
<li><p><strong>构建多级缓存架构</strong> </p>
<p>​    Nginx缓存+redis缓存+ehcache缓存 </p>
</li>
<li><p><strong>检测Mysql严重耗时业务进行优化</strong> </p>
<p>​    对数据库的瓶颈排查：例如超时查询、耗时较高事务等 </p>
</li>
<li><p><strong>灾难预警机制</strong> </p>
<p>​    监控redis服务器性能指标 </p>
<ul>
<li><p>CPU占用、CPU使用率 </p>
</li>
<li><p>内存容量 </p>
</li>
</ul>
<ul>
<li>查询平均响应时间 </li>
</ul>
<ul>
<li>线程数 </li>
</ul>
</li>
<li><p><strong>限流、降级</strong> </p>
</li>
</ol>
<p>​    短时间范围内牺牲一些客户体验，限制一部分请求访问，降低应用服务器压力，待业务低速运转后再逐步放开访问</p>
<p><strong>解决方案（术）</strong></p>
<ol>
<li><p><strong>LRU与LFU切换</strong> </p>
</li>
<li><p><strong>数据有效期策略调整</strong> </p>
<p>根据业务数据有效期进行分类错峰，A类90分钟，B类80分钟，C类70分钟 </p>
<p>过期时间使用固定时间+随机值的形式，稀释集中到期的key的数量 </p>
</li>
<li><p><strong>超热数据使用永久key</strong> </p>
</li>
<li><p><strong>定期维护（自动+人工）</strong> </p>
<p>对即将过期数据做访问量分析，确认是否延时，配合访问量统计，做热点数据的延时 </p>
</li>
<li><p><strong>加锁 慎用！</strong></p>
</li>
</ol>
<p><strong>总结</strong></p>
<p>缓存雪崩就是瞬间过期数据量太大，导致对数据库服务器造成压力。如能够有效避免过期时间集中，可以有效解决雪崩现象的出现 （约40%），配合其他策略一起使用，并监控服务器的运行数据，根据运行记录做快速调整。</p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020162205314.png" srcset="/img/loading.gif" lazyload alt="image-20221020162205314"></p>
<h2 id="缓存击穿"><a href="#缓存击穿" class="headerlink" title="缓存击穿"></a>缓存击穿</h2><p><strong>数据库服务器崩溃（2）</strong></p>
<ol>
<li>系统平稳运行过程中 </li>
<li>数据库连接量瞬间激增 </li>
<li>Redis服务器无大量key过期 </li>
<li>Redis内存平稳，无波动 </li>
<li>Redis服务器CPU正常 </li>
<li>数据库崩溃</li>
</ol>
<p><strong>问题排查</strong></p>
<ol>
<li>Redis中某个key过期，该key访问量巨大 </li>
<li>多个数据请求从服务器直接压到Redis后，均未命中 </li>
<li>Redis在短时间内发起了大量对数据库中同一数据的访问</li>
</ol>
<p><strong>问题分析</strong></p>
<ul>
<li>单个key高热数据 </li>
<li>key过期</li>
</ul>
<p><strong>解决方案（术）</strong></p>
<ol>
<li><p><strong>预先设定</strong> </p>
<p>​    以电商为例，每个商家根据店铺等级，指定若干款主打商品，在购物节期间，加大此类信息    key的过期时长 </p>
<p>​    注意：购物节不仅仅指当天，以及后续若干天，访问峰值呈现逐渐降低的趋势 </p>
</li>
<li><p><strong>现场调整</strong> </p>
<p>​    监控访问量，对自然流量激增的数据延长过期时间或设置为永久性key </p>
</li>
<li><p><strong>后台刷新数据</strong> </p>
<p>​    启动定时任务，高峰期来临之前，刷新数据有效期，确保不丢失 </p>
</li>
<li><p><strong>二级缓存</strong> </p>
<p>​    设置不同的失效时间，保障不会被同时淘汰就行 </p>
</li>
<li><p><strong>加锁</strong> </p>
<p>​    分布式锁，防止被击穿，但是要注意也是性能瓶颈，慎重！</p>
</li>
</ol>
<p><strong>总结</strong></p>
<p>缓存击穿就是单个高热数据过期的瞬间，数据访问量较大，未命中redis后，发起了大量对同一数据的数据库访问，导致对数据库服务器造成压力。应对策略应该在业务数据分析与预防方面进行，配合运行监控测试与即时调整策略，毕竟单个key的过期监控难度较高，配合雪崩处理策略即可。</p>
<h2 id="缓存穿透"><a href="#缓存穿透" class="headerlink" title="缓存穿透"></a>缓存穿透</h2><p><strong>数据库服务器崩溃（3）</strong></p>
<ol>
<li>系统平稳运行过程中 </li>
<li>应用服务器流量随时间增量较大 </li>
<li>Redis服务器命中率随时间逐步降低 </li>
<li>Redis内存平稳，内存无压力 </li>
<li>Redis服务器CPU占用激增 </li>
<li>数据库服务器压力激增 </li>
<li>数据库崩溃</li>
</ol>
<p><strong>问题排查</strong></p>
<ol>
<li>Redis中大面积出现未命中 </li>
<li>出现非正常URL访问</li>
</ol>
<p><strong>问题分析</strong></p>
<ul>
<li>获取的数据在数据库中也不存在，数据库查询未得到对应数据 </li>
<li>Redis获取到null数据未进行持久化，直接返回 </li>
<li>下次此类数据到达重复上述过程 </li>
<li>出现黑客攻击服务器</li>
</ul>
<p><strong>解决方案（术）</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020164447238.png" srcset="/img/loading.gif" lazyload alt="image-20221020164447238"></p>
<p><strong>总结</strong></p>
<p>缓存击穿访问了不存在的数据，跳过了合法数据的redis数据缓存阶段，每次访问数据库，导致对数据库服务器造成压力。通常此类 数据的出现量是一个较低的值，当出现此类情况以毒攻毒，并及时报警。应对策略应该在临时预案防范方面多做文章。 </p>
<p>无论是黑名单还是白名单，都是对整体系统的压力，警报解除后尽快移除。</p>
<h2 id="性能指标监控"><a href="#性能指标监控" class="headerlink" title="性能指标监控"></a>性能指标监控</h2><p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020165330711.png" srcset="/img/loading.gif" lazyload alt="image-20221020165330711"></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020165344324.png" srcset="/img/loading.gif" lazyload alt="image-20221020165344324"></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020165518327.png" srcset="/img/loading.gif" lazyload alt="image-20221020165518327"></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020165557352.png" srcset="/img/loading.gif" lazyload alt="image-20221020165557352"></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020165707597.png" srcset="/img/loading.gif" lazyload alt="image-20221020165707597"></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020165743895.png" srcset="/img/loading.gif" lazyload alt="image-20221020165743895"></p>
<p><strong>监控方式</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020165841955.png" srcset="/img/loading.gif" lazyload alt="image-20221020165841955"></p>
<p><strong>benchmark</strong></p>
<ul>
<li>命令</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">redis-benchmark <span class="token punctuation">[</span>-h <span class="token punctuation">]</span> <span class="token punctuation">[</span>-p <span class="token punctuation">]</span> <span class="token punctuation">[</span>-c <span class="token punctuation">]</span> <span class="token punctuation">[</span>-n <span class="token operator">&lt;</span>requests<span class="token punctuation">]</span><span class="token operator">></span> <span class="token punctuation">[</span>-k <span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li>范例1</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">redis-benchmark<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>说明：50个连接，10000次请求对应的性能</p>
<ul>
<li>范例2</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">redis-benchmark <span class="token parameter variable">-c</span> <span class="token number">100</span> <span class="token parameter variable">-n</span> <span class="token number">5000</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>说明：100个连接，5000次请求对应的性能</p>
<p><strong>演示</strong></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020170658042.png" srcset="/img/loading.gif" lazyload alt="image-20221020170658042"></p>
<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020170824761.png" srcset="/img/loading.gif" lazyload alt="image-20221020170824761"></p>
<p><strong>monitor</strong></p>
<ul>
<li>命令</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">monitor<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>打印服务器调试信息</p>
<p><strong>showlong</strong></p>
<ul>
<li>命令</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">slowlog <span class="token punctuation">[</span>operator<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<ul>
<li><p>get ：获取慢查询日志 </p>
</li>
<li><p>len ：获取慢查询日志条目数 </p>
</li>
<li><p>reset ：重置慢查询日志</p>
</li>
<li><p>相关配置</p>
</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">slowlog-log-slower-than <span class="token number">1000</span> <span class="token comment">#设置慢查询的时间下线，单位：微妙</span>
slowlog-max-len <span class="token number">100</span> <span class="token comment">#设置慢查询命令对应的日志显示长度，单位：命令数</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p><img src="/img/%E9%BB%91%E9%A9%AC%E7%A8%8B%E5%BA%8F%E5%91%98-Redis/image-20221020171634657.png" srcset="/img/loading.gif" lazyload alt="image-20221020171634657"></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" class="category-chain-item">数据库</a>
  
  
    <span>></span>
    
  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/" class="category-chain-item">Redis</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>黑马程序员-Redis</div>
      <div>https://weishao-996.github.io/2022/10/08/黑马程序员-Redis/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Wei Shao</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2022年10月8日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/10/08/MacOS-M1%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85-HomeBrew/" title="MacOS-M1软件安装-HomeBrew">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">MacOS-M1软件安装-HomeBrew</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/09/14/%E9%9D%A2%E8%AF%95-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" title="面试-计算机网络">
                        <span class="hidden-mobile">面试-计算机网络</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script  src="https://lib.baomitu.com/prism/1.27.0/plugins/line-numbers/prism-line-numbers.min.js" ></script>

  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
